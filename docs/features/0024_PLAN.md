# Feature 0024: Remove Habit Category from Telegram Interface

## Overview

Simplify the Telegram habit management UX by removing the "Category" field from
the `/add_habit` and `/edit_habit` flows, while keeping the database model and
REST API fully supporting `category`. The user request is:

- "from telegram interface remove \"Category\" field. I don't want to maintain that field."
- "And don't show brackets after Habit name"
- "don't change database and REST API put None by default"
- "Don't forget to plan unit tests and integration test script test_api,sh"

New habits created via Telegram should default `category` to `None` (or omit it
entirely), and Telegram should no longer display category labels or brackets
around habit names, even if a category exists in the database.

## Current Behavior (High-Level)

- `/add_habit` flow (`src/bot/handlers/habit_management_handler.py`):
  - States: `AWAITING_HABIT_NAME` → `AWAITING_HABIT_WEIGHT` → `AWAITING_HABIT_CATEGORY`
    → `AWAITING_GRACE_DAYS` → `AWAITING_EXEMPT_DAYS` → `AWAITING_HABIT_CONFIRMATION`.
  - After weight selection, the bot shows a category selection keyboard built
    by `build_category_selection_keyboard` and stores `context.user_data['habit_category']`.
  - Confirmation summary uses `HELP_ADD_HABIT_CONFIRM` with placeholders
    `{name}`, `{weight}`, `{category}`, `{grace_days}`, `{exempt_days}`.
  - On confirmation, the handler builds a `new_habit` dict including a
    `category` field and calls `habit_repository.create`.

- `/edit_habit` flow (`src/bot/handlers/habit_management_handler.py`):
  - States: `AWAITING_HABIT_SELECTION` → `AWAITING_EDIT_NAME` → `AWAITING_EDIT_WEIGHT`
    → `AWAITING_EDIT_CATEGORY` → `AWAITING_EDIT_GRACE_DAYS`
    → `AWAITING_EDIT_EXEMPT_DAYS` → `AWAITING_EDIT_CONFIRMATION`.
  - The edit flow stores `old_habit_category` / `new_habit_category` in
    `context.user_data` and uses `build_category_selection_keyboard` with
    `skip_callback="skip_category"` to support skipping category edits.
  - Confirmation summary uses `HELP_EDIT_HABIT_CONFIRM` with `{old_category}` and
    `{new_category}` placeholders.
  - `habit_edit_confirmed` builds an `updates` dict that may include `category`
    and passes it to `habit_repository.update`.

- Habit name display in keyboards (`src/bot/keyboards.py`):
  - `build_habits_for_edit_keyboard` renders buttons as `"Habit Name (category)"`
    when `habit.category` is set, which can result in trailing `()` or
    `(None)`-like brackets for missing/placeholder categories.
  - `build_post_create_habit_keyboard` similarly displays `"• Habit Name (category)"`.

- Backend and API:
  - Django model `Habit.category` (`src/core/models.py`) is `CharField` with
    `null=True` and `blank=True`, indexed and used for filtering.
  - `HabitRepository.create` and `HabitRepository.update`
    (`src/core/repositories.py`) accept `category` but do not require it.
  - REST API (`src/api/v1/routers/habits.py` and tests under `tests/api/`) expose
    `category` as an optional field and allow filtering by category.
  - Integration script `scripts/test_api.sh` creates habits with and without
    `category` and asserts on the field in responses; this targets the API, not
    the Telegram bot.

## Goals and Non-Goals

**Goals**
- Remove the category selection/editing steps from Telegram `/add_habit` and
  `/edit_habit` flows.
- Ensure new habits created via Telegram have `category=None` (or no category
  field set) without validation errors or UX regressions.
- Stop showing category labels and brackets after habit names in Telegram
  keyboards and confirmation messages.
- Keep database, service layer, and REST API semantics for `category`
  unchanged so other clients (API, dashboard, admin) can continue using it.

**Non-Goals**
- No changes to Django models, migrations, or database schema for `Habit`.
- No changes to REST API request/response schemas or query parameters related
  to `category`.
- No removal of `category` from non-Telegram documentation, analytics, or
  internal audit logging where it is still useful.

## Files and Components to Touch

- Telegram habit handlers:
  - `src/bot/handlers/habit_management_handler.py`
    - `/add_habit` flow: `habit_weight_selected`, `habit_category_selected`,
      `habit_grace_days_selected`, `habit_exempt_days_selected`,
      `habit_exempt_days_text_received`, `habit_confirmed`, and
      `add_habit_conversation` state map.
    - `/edit_habit` flow: `habit_edit_selected`, `habit_edit_name_received`,
      `habit_edit_name_skip`, `habit_edit_weight_selected`,
      `habit_edit_weight_skip`, `habit_edit_category_selected`,
      `habit_edit_category_skip`, `habit_edit_grace_days_selected`,
      `habit_edit_grace_days_skip`, `habit_edit_exempt_days_selected`,
      `habit_edit_exempt_days_skip`, `habit_edit_exempt_days_text_received`,
      `habit_edit_confirmed`, and `edit_habit_conversation` state map.

- Telegram keyboards:
  - `src/bot/keyboards.py`
    - `build_category_selection_keyboard` (may become unused by Telegram).
    - `build_habits_for_edit_keyboard` (remove `({habit.category})` suffix).
    - `build_post_create_habit_keyboard` (remove `({habit.category})` suffix).

- Messages and translations:
  - `src/bot/messages.py`
    - Habit management messages:
      - `HELP_ADD_HABIT_CATEGORY_PROMPT`
      - `HELP_EDIT_HABIT_CATEGORY_PROMPT`
      - `HELP_ADD_HABIT_CONFIRM`
      - `HELP_EDIT_HABIT_CONFIRM`
    - Corresponding entries in `Messages._TRANSLATIONS` for all supported
      languages (en, ru, kk).

- Configuration (read-only from Telegram perspective):
  - `src/config.py`
    - `HABIT_CATEGORIES` constant (kept for REST/dashboard and future use).

- Tests:
  - Telegram bot unit tests:
    - `tests/test_habit_edit_skip.py` (category-related skip logic and keyboards).
    - `tests/test_bot_handlers.py` (habit lists and habit flows that reference
      category or brackets).
  - Service/API tests (regression only, no behavior change expected):
    - `tests/test_habit_service.py`
    - `tests/api/test_habits.py` and `tests/api/conftest.py`
  - Integration script:
    - `scripts/test_api.sh` (ensure it still passes and validates `category`
      where appropriate).

## Implementation Plan

### 1. Remove Category from `/add_habit` Flow

1.1 Conversation state simplification
- In `habit_management_handler.py`, stop using `AWAITING_HABIT_CATEGORY`:
  - After `habit_weight_selected`, transition directly to `AWAITING_GRACE_DAYS`
    instead of showing the category keyboard.
  - Remove the `AWAITING_HABIT_CATEGORY` entry from the `add_habit_conversation`
    `states` mapping so no callbacks can land there.
- Keep state constants defined if needed for backward compatibility, but they
  should no longer be reachable in the Telegram flow.

1.2 Context data and confirmation summary
- Stop writing `context.user_data['habit_category']` during habit creation.
- When building the confirmation message in `habit_exempt_days_selected` /
  `habit_exempt_days_text_received`:
  - Remove `category` from the argument list passed to `msg('HELP_ADD_HABIT_CONFIRM', ...)`.
  - Update the `HELP_ADD_HABIT_CONFIRM` template in `Messages` to exclude the
    `<b>Category:</b> {category}` line; confirmation should show only Name,
    Weight, Grace Days, and Exempt Days.

1.3 Habit creation payload and defaults
- In `habit_confirmed`, when building the `new_habit` dict passed to
  `habit_repository.create`, either:
  - Omit the `category` key entirely, or
  - Explicitly set `category` to `None`.
- Verify that `HabitRepository.create` and the Django model accept missing or
  `None` category without raising errors and that the stored DB value is NULL.
- This satisfies the requirement to "put None by default" for category when
  creating habits through Telegram, while leaving API-created habits free to
  set a category.

1.4 Logging and telemetry
- Review any audit log calls in the `/add_habit` flow (e.g., snapshot fields
  for habit creation) and:
  - Either omit `habit_category` from snapshots triggered by Telegram flows, or
  - Set it to `None`/`"None"` consistently.
- Ensure these snapshot changes are not user-visible and that existing audit
  log tests remain valid (or update them to tolerate a `None` value where
  appropriate).

### 2. Remove Category from `/edit_habit` Flow

2.1 Conversation state simplification
- In the `edit_habit_conversation` definition:
  - Remove the `AWAITING_EDIT_CATEGORY` state mapping entirely, including
    handlers for `habit_edit_category_skip` and `habit_edit_category_selected`.
  - After `AWAITING_EDIT_WEIGHT`, transition directly to
    `AWAITING_EDIT_GRACE_DAYS`.
- Update skip handlers to match the new state sequence:
  - `habit_edit_name_skip` remains unchanged (goes to weight).
  - `habit_edit_weight_skip` should now advance directly to grace days selection
    (`AWAITING_EDIT_GRACE_DAYS`) instead of the removed category step.

2.2 Context data and confirmation summary
- Remove reliance on `old_habit_category` / `new_habit_category` in the edit
  flow:
  - Stop setting these keys when loading a habit for editing.
  - Stop reading them when constructing the edit confirmation summary or
    snapshots.
- Update `HELP_EDIT_HABIT_CONFIRM` in `Messages` to remove the Category line,
  so the summary compares only Name, Weight, Grace Days, and Exempt Days.
- Verify that text for all supported languages is updated consistently and no
  leftover `{old_category}` / `{new_category}` placeholders remain.

2.3 Update payload behavior
- In `habit_edit_confirmed`, ensure the `updates` dict passed to
  `habit_repository.update` never includes a `category` key for Telegram edits,
  so existing categories are preserved in the database.
- Add guardrails in code (and tests) so that:
  - Editing other fields via Telegram does not clear or modify `Habit.category`.
  - Users cannot inadvertently change categories from Telegram once this
    feature is removed.

2.4 Cleanup of unused handlers (optional)
- If no other flows use `habit_edit_category_selected` or
  `habit_edit_category_skip`, consider:
  - Removing these functions and any related logging to reduce surface area, or
  - Leaving them in place but clearly unused (for potential future reactivation).
- Ensure any references in `RULES.md` or older feature docs are updated to
  reflect that category editing is no longer available in Telegram.

### 3. Remove Category/Brackets from Habit Name Displays

3.1 Edit/remove habit keyboards
- In `build_habits_for_edit_keyboard`:
  - Change the button label to always be just `habit.name` with no appended
    category, even if `habit.category` is set.
  - This guarantees no trailing brackets like `"Habit Name ()"` or
    `"Habit Name (None)"` appear in the Telegram UI.

3.2 Post-create habit list keyboard
- In `build_post_create_habit_keyboard`:
  - Change the display line from `"• Habit Name (category)"` to `"• Habit Name"`.
  - This affects the informational list shown after creating a habit so it no
    longer shows brackets after the habit name.

3.3 Search for other bracketed category displays
- Search for other usages of `({habit.category})` or similar concatenation in
  `src/bot/`:
  - If any other keyboards or messages show `"Habit Name (category)"`, remove
    the category suffix for Telegram-specific contexts.
  - Keep category displays in dashboard or API-driven UIs untouched.

### 4. Preserve DB and REST API Contracts

4.1 Model and repository behavior
- Leave `Habit.category` in `src/core/models.py` unchanged (type, nullability,
  indexes, and help text).
- Leave `HabitRepository.create` and `HabitRepository.update` unchanged; only
  adjust the data passed from Telegram handlers so category is optional.

4.2 REST API behavior
- Confirm that REST endpoints for habits (create, update, list, filter) still
  expose and honor `category` exactly as described in `docs/features/0022_PLAN.md`.
- No changes to Pydantic schemas, query parameters, or response payloads for
  `category`.

4.3 Configuration and other clients
- Keep `HABIT_CATEGORIES` in `src/config.py`:
  - Telegram will no longer use it directly.
  - API clients or dashboard views can continue using it for category dropdowns,
    analytics, or filtering.

### 5. Documentation Alignment

- Update `RULES.md` habit UX sections to state that:
  - Telegram `/add_habit` and `/edit_habit` no longer ask for or modify
    `category`.
  - Category remains an optional analytical field available via API and admin.
- Update relevant test documentation (`docs/TEST_CASES.md`,
  `docs/MANUAL_TESTING_GUIDE.md`, `docs/COMPREHENSIVE_TEST_PLAN.md`) where
  they describe Telegram flows that currently include category selection or
  display in bot messages.
- Avoid changing API-focused documentation (e.g., examples that show
  `"category": "health"` in REST payloads) since API behavior remains valid.

## Testing Plan

### Unit Tests (Telegram Bot)

- `tests/test_habit_edit_skip.py`:
  - Remove or refactor tests that depend on `AWAITING_EDIT_CATEGORY`,
    `habit_edit_category_skip`, and category keyboard behavior.
  - Update expectations so skipping weight advances directly to grace days,
    and the skip-all test verifies the sequence:
    name → weight → grace days → exempt days → confirmation.

- `tests/test_bot_handlers.py` (and any dedicated habit handler tests):
  - Add/adjust tests for `/add_habit`:
    - After weight selection, the next state should be grace days; there should
      be no category prompt.
    - The final confirmation message should not contain a "Category" line.
  - Add/adjust tests for `/edit_habit`:
    - Flow should not enter a category editing state.
    - Edit confirmation messages should compare only name, weight, grace days,
      and exempt days.
  - Add tests to assert habit keyboards do not show brackets:
    - `build_habits_for_edit_keyboard` produces labels with `habit.name` only.
    - `build_post_create_habit_keyboard` lists habits as `"• Habit Name"` with
      no `(...)` suffix, even when `habit.category` is non-null.

- Ensure existing audit log tests in `tests/test_audit_logs.py` still pass:
  - Where they manually specify `habit_category` in snapshots, behavior is
    unchanged (these tests exercise the logging infrastructure, not Telegram).

### Service/API Regression Tests

- Run existing service tests:
  - `pytest tests/test_habit_service.py` to ensure that habits without a
    category are still processed correctly.

- Run API tests under `tests/api/`:
  - Focus on `tests/api/test_habits.py` to confirm:
    - Creating/updating habits with and without `category` still works.
    - Filtering by `category` continues to behave as before.

### Integration Test Script (`scripts/test_api.sh`)

- Keep `scripts/test_api.sh` as-is; it already covers API-level `category`
  behavior (e.g., creating a habit with `"category": "learning"`).
- After implementing the Telegram changes, run:
  - `./scripts/test_api.sh`
  - Confirm all sections pass, demonstrating that REST behavior and schema are
    unchanged despite the Telegram UI simplification.

### Manual Telegram Verification

- In a development environment, manually verify in all supported languages:
  - `/add_habit`:
    - Flow collects name, weight, grace days, and exempt days only.
    - No step asks for category.
    - Confirmation summary shows no "Category" line.
  - `/edit_habit`:
    - Flow lets you edit name, weight, grace days, and exempt days.
    - No category selection appears.
    - Confirmation summary shows no category comparison.
  - Habit lists in menus and post-create screens:
    - Habit names appear without brackets, even for habits that have a
      non-null `category` in the database.

## Risks and Mitigations

- **Risk:** Removing category states and handlers leaves dead code or invalid
  conversation paths.
  - **Mitigation:** Keep conversation state maps in sync with actual handlers;
    add/update unit tests to cover happy paths and cancellation edges for both
    `/add_habit` and `/edit_habit`.

- **Risk:** Existing categories accidentally cleared or modified during edits.
  - **Mitigation:** Ensure `updates` payloads for edits never include
    `category`; add regression tests to verify `Habit.category` remains
    unchanged when editing via Telegram.

- **Risk:** Inconsistent understanding across docs and team about Category
  usage (Telegram vs API/dashboard).
  - **Mitigation:** Update rules and test docs to clearly state that
    Telegram ignores category while REST and other clients may continue to use
    it; highlight that new Telegram-created habits default to `category=None`.

