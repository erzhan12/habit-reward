# Feature 0013: Revert Habit Completion

## Overview
Allow users to undo a mistaken `/habit_done` command by removing the most recent habit log for a chosen habit and restoring any reward progress that was granted as part of that log. The operation should behave the same regardless of how much time has passed since the original completion.

## Current State Analysis (Verified)
- `src/services/habit_service.py` orchestrates habit completion via `process_habit_completion()`; it inserts a `HabitLog` entry and calls `reward_service.update_reward_progress()` when a reward was earned.
- `src/core/repositories.py` exposes `HabitLogRepository.create()` and `get_last_log_for_habit()` but has no helper to delete a log.
- `RewardProgressRepository.update()` can overwrite fields but there is no safe way to decrement `pieces_earned` or reset `claimed`.
- `src/services/reward_service.py` only offers additive progress helpers; there is no rollback operation.
- `src/bot/handlers/habit_done_handler.py` (and menu routing) provide the completion flow only—there is no `/revert_habit` handler or menu entry today.
- `src/bot/messages.py` / `_TRANSLATIONS` and `src/bot/keyboards.py` do not contain copy or keyboards for a revert scenario.
- Streak counts are derived from existing logs (`src/services/streak_service.py`), so removing a log automatically recalculates the correct streak. ✅
- `RewardProgress.status` is computed (`src/core/models.py:206-228`), so it tracks `pieces_earned/claimed` without extra bookkeeping. ✅

## Requirements from User
- Provide a dedicated `/revert_habit` command (no inline undo button) that is available at any time.
- Revert every change made by the most recent completion of the selected habit: delete the `HabitLog` row and restore reward progress.
- The feature must still work if the reward that completion granted has already been claimed.
- No additional audit logging is required.

## Technical Design

### Data Reversion Algorithm (Updated)
1. Add `HabitService.revert_habit_completion(user_telegram_id: str, habit_id: int | str) -> HabitRevertResult`.
2. Validate that the user exists and `is_active`; raise `ValueError` on failure (mirrors `process_habit_completion` semantics).
3. Fetch the habit with `habit_repo.get_by_id`; require `habit.active` to guard against stale selections.
4. Load the most recent log for `(user.id, habit.id)` with `habit_log_repo.get_last_log_for_habit`. If none exists, raise `ValueError("No habit completion found to revert")`.
5. Persist the log metadata (`got_reward`, `reward_id`, `timestamp`) before modifying anything.
6. Execute the rollback inside a single transaction to prevent partial updates:
   ```python
   async with transaction.atomic():
       deleted = await self.habit_log_repo.delete(log.id)
       if deleted == 0:
           raise ValueError("No habit completion found to revert")

       reward_progress = None
       if log.got_reward and log.reward_id:
           reward_progress = await self.reward_progress_repo.decrement_pieces_earned(
               user.id,
               log.reward_id,
           )
   ```
   - `decrement_pieces_earned` must clamp the counter at zero and reset `claimed=False` whenever we reduce pieces so the computed status no longer shows `✅ Claimed`.
7. Return a `HabitRevertResult` instance containing the habit name, whether a reward was rolled back, and the updated `RewardProgress` snapshot for downstream messaging.
8. Keep existing logging style (`logger.info` / `logger.error`) so we have parity with `process_habit_completion`.

### Repository Layer Changes
- **HabitLogRepository** (`src/core/repositories.py`):
  - Add `async def delete(self, log_id: int | str) -> int` that converts the PK to `int`, calls `HabitLog.objects.filter(pk=pk).delete()` via `sync_to_async`, and returns the deleted row count.
- **RewardProgressRepository**:
  - Add `async def decrement_pieces_earned(self, user_id: int | str, reward_id: int | str) -> RewardProgress | None`:
    - Fetch the progress record with `get_by_user_and_reward`.
    - If none exists, return `None` so the service can log a warning but continue.
    - Compute `new_pieces = max(0, progress.pieces_earned - 1)`.
    - Build `updates = {"pieces_earned": new_pieces}` and include `claimed=False` when `progress.claimed` is `True` or when `new_pieces < progress.pieces_earned`.
    - Reuse `update()` to persist and return the refreshed ORM object (still `select_related('reward', 'user')`).

### Model Updates
- Introduce `src/models/habit_revert_result.py` (Pydantic) with fields:
  - `habit_name: str`
  - `reward_reverted: bool`
  - `reward_progress: RewardProgress | None`
  - `success: bool = True`
  - Optional helper properties (e.g., `reward_name`, `pieces_earned`, `pieces_required`) to simplify formatting.

### Service Layer Changes
- Import `reward_progress_repository` and `transaction` (`from django.db import transaction`).
- Update `HabitService.__init__` to store `self.reward_progress_repo = reward_progress_repository`.
- Implement `revert_habit_completion` as described above, returning `HabitRevertResult` (populated with ORM data; Pydantic will coerce as with `HabitCompletionResult`).
- Raise `ValueError` with clear strings that map 1:1 to new message constants (`ERROR_NO_LOG_TO_REVERT`, etc.).

### Bot Handler & Routing
- Create `src/bot/handlers/habit_revert_handler.py` with a `ConversationHandler`:
  - `habit_revert_command`:
    - Derive `telegram_id`, resolve language via `get_message_language_async`.
    - Validate the user using `user_repository` (`ERROR_USER_NOT_FOUND` / `ERROR_USER_INACTIVE`).
    - Fetch habits with `habit_service.get_all_active_habits()`. If empty, reuse `ERROR_NO_HABITS`.
    - Send `msg('HELP_REVERT_HABIT_SELECTION', lang)` with `build_habit_revert_keyboard`.
  - `habit_revert_selected_callback`:
    - Parse `revert_habit_<id>`; locate the habit from the cached list (or refetch).
    - Call `habit_service.revert_habit_completion(telegram_id, habit.id)` inside `try`.
    - On success, compose response:
      - Always send `SUCCESS_HABIT_REVERTED`.
      - If `result.reward_reverted` and progress available, append `SUCCESS_REWARD_REVERTED` (include `reward_progress.reward.name` + counts).
    - On `ValueError("No habit completion...")`, send `ERROR_NO_LOG_TO_REVERT`.
    - Any other `ValueError` -> `ERROR_GENERAL`.
    - Reply with `build_back_to_menu_keyboard(lang)` and `parse_mode="HTML"`, then end conversation.
  - `cancel_revert_handler` responds with `INFO_CANCELLED_REVERT`.
- Register conversation states (`AWAITING_REVERT_SELECTION = 1`) mirroring the `/habit_done` pattern.
- Wire up in `src/bot/main.py` (`application.add_handler(habit_revert_conversation)` after the `/habit_done` handler).
- Update `src/bot/handlers/menu_handler.py`:
  - Add a `menu_habits_revert` mapping in `bridge_command_callback` to call `habit_revert_command`.
  - Ensure navigation stack pushes this route so Back works.
- Add the module to any `__all__` exports if applicable.

### Messaging & Localization
- In `src/bot/messages.py` add English defaults:
  - `BUTTON_REVERT_HABIT = "↩️ Revert Habit"`
  - `HELP_REVERT_HABIT_SELECTION = "Which habit completion would you like to revert?"`
  - `SUCCESS_HABIT_REVERTED = "✅ <b>Habit completion reverted:</b> {habit_name}"`
  - `SUCCESS_REWARD_REVERTED = "Reward progress rolled back: {reward_name} ({pieces_earned}/{pieces_required})"`
  - `ERROR_NO_LOG_TO_REVERT = "No habit completion found to revert."`
  - `INFO_CANCELLED_REVERT = "Revert cancelled."`
- Extend `_TRANSLATIONS['ru']` and `_TRANSLATIONS['kk']` with equivalent strings (keep placeholders and HTML formatting consistent).
- Update `HELP_START_MESSAGE` and `HELP_COMMAND_MESSAGE` to mention `/revert_habit`.

### Keyboards
- Add `build_habit_revert_keyboard(habits: list[Habit], language: str = 'en') -> InlineKeyboardMarkup` in `src/bot/keyboards.py`:
  - Buttons: one per habit (`text=habit.name`, `callback_data=f"revert_habit_{habit.id}"`).
  - Append a Back button using `msg('MENU_BACK', language)` and callback `menu_back`.
- Update `build_habits_menu_keyboard` to insert the new `BUTTON_REVERT_HABIT` button (callback `menu_habits_revert`) above the Back row.

### Menu and Help Copy
- Ensure `menu_handler` recognizes `menu_habits_revert` within navigation.
- If we surface `/revert_habit` elsewhere (e.g., settings/menu quick actions), add localized button labels there as well.

### Testing Strategy
- **Service tests** (`tests/test_habit_service.py`):
  - Async tests for `revert_habit_completion` covering success (with and without reward), no log error, inactive user, and reward progress already at zero.
- **Repository tests** (`tests/test_repositories.py`):
  - Unit tests for `HabitLogRepository.delete` and `RewardProgressRepository.decrement_pieces_earned` (use the Django test database with factories or mocks).
- **Handler tests** (`tests/test_bot_handlers.py`):
  - Conversation-level async tests ensuring the command presents the keyboard and handles success/error paths.
- Run `make check` and `uv run pytest tests/` before shipping.
