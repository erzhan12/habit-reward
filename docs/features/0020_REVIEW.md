# Feature 0020 Code Review

- **Critical – “Select Date” button is unhandled.** The quick picker button emits `backdate_habit_{id}` (`src/bot/keyboards.py:874-885`), but neither the `/habit_done` conversation (`src/bot/handlers/habit_done_handler.py:433-444`) nor the backdate conversation entry points (`src/bot/handlers/backdate_handler.py:363-377`) match that pattern. Pressing “Select Date” leaves the callback with no handler, so the date picker flow never starts.
- **Critical – Backdating corrupts streak state for existing logs.** Logs are fetched by latest *timestamp* (`src/core/repositories.py:411-427`), so a newly-created backdated entry (timestamp now, `last_completed_date` in the past) becomes the “latest” log. Existing newer-day logs keep their original streak_count, and no recalculation/updates occur when inserting a past log (`src/services/habit_service.py:222-277`). Scenario: log today (streak=1), then backdate yesterday → the newest record is the backdated one with streak=1, `/streaks` now reports 1 and today’s log still stores streak=1 instead of 2. This violates the “streak recalculation” requirement.
- **Major – Date picker only covers 6 days back.** The completed-date fetch starts at `today - 6` (`src/bot/handlers/backdate_handler.py:149-155`), and the picker builds a 7-day list (`src/bot/keyboards.py:915-917`), so users cannot select `today - 7` even though the service allows 7-day backdating.
- **Major – Logger missing in streak service.** `calculate_streak_for_date` calls `logger.warning(...)` (`src/services/streak_service.py:153-157`), but the module never imports or defines `logger`, so hitting that branch raises `NameError`.
- **Minor – Tests don’t exercise backdate logic.** The “success” tests only assert date arithmetic and never call `process_habit_completion` (`tests/test_backdate_habit.py:82-130`), and repository tests are placeholders (`tests/test_backdate_habit.py:462-484`). Key behaviours like streak recalculation and duplicate prevention lack automated coverage.
