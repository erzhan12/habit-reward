# Feature 0026: Secure External API Access for Habit Completion

## Overview

Enable secure external access to the habit_done functionality from:
1. **Web/Mobile applications** - User-facing apps where humans login
2. **Automated integrations** - Fitness apps, iOS Shortcuts, scripts that call API without human interaction

The existing REST API (`POST /v1/habits/{habit_id}/complete`) already provides habit completion capability but has a **critical security flaw**: anyone who knows a user's `telegram_id` can login as them.

This feature adds **two authentication mechanisms**:
- **Auth Code Flow** - For web/mobile apps (human login)
- **API Keys** - For automated integrations (no human needed)

## Current State

The codebase already has:
- `POST /v1/habits/{habit_id}/complete` - Habit completion endpoint (`src/api/v1/routers/habits.py:423`)
- `POST /v1/habits/batch-complete` - Batch completion endpoint (`src/api/v1/routers/habits.py:523`)
- JWT authentication via `get_current_active_user` dependency (`src/api/dependencies/auth.py:183`)
- Login via `telegram_id` (`src/api/v1/routers/auth.py`)

**Security Problem**: Current login only requires `telegram_id`. Telegram IDs are not secret (visible in groups, bots, forwarded messages). Anyone who knows a user's ID can impersonate them.

### Terminology: Eligible vs Authenticated

- **Telegram-linked / eligible to authenticate**: a `users` table row exists and `telegram_id` is filled. This indicates the user has already linked their Telegram account (typically by interacting with the bot) and is allowed to start an authentication flow.
- **Authenticated**: the caller has proven control of the Telegram account (auth code delivered via Telegram) or possession of an API key, and only then receives access (JWT) or is authorized per-request (API key).

Important: `telegram_id` is an **identifier**, not a **credential**. It must never be sufficient on its own to mint tokens or access protected endpoints.

## Proposed Solution

### Two Authentication Methods

| Method | Use Case | Example | Human Needed? |
|--------|----------|---------|---------------|
| **Auth Code** | Web/mobile app login | User opens habit tracker app | Yes (once per session) |
| **API Key** | Automated integrations | Fitness app registers habit | No (fully automated) |

### Auth Code Flow (for web/mobile apps)
1. Web/mobile app requests auth code for a `telegram_id` (identifier)
2. If the user is Telegram-linked/eligible, server sends the code to that Telegram account via the bot (proves ownership)
3. User enters code in web/mobile app
4. App exchanges code for JWT tokens

### API Key Flow (for automated integrations)
1. User creates API key via Telegram bot (one-time setup)
2. User copies key to their fitness app / automation
3. App includes `X-API-Key` header in requests
4. No human interaction needed for each request

## Files to Create/Modify

### New Files

1. **`src/core/models.py`** - Add `AuthCode` and `APIKey` models
   ```python
   class AuthCode(models.Model):
       user = ForeignKey(User, on_delete=CASCADE)
       code = CharField(max_length=6)        # 6-digit numeric code
       created_at = DateTimeField(auto_now_add=True)
       expires_at = DateTimeField()          # 5 minutes from creation
       used = BooleanField(default=False)
       device_info = CharField(null=True)    # Optional: "iPhone", "Chrome"

   class APIKey(models.Model):
       user = ForeignKey(User, on_delete=CASCADE)
       key_hash = CharField(max_length=64)   # SHA256 hash, never store plaintext
       name = CharField(max_length=100)      # User-friendly name: "Fitness App"
       created_at = DateTimeField(auto_now_add=True)
       last_used_at = DateTimeField(null=True)
       is_active = BooleanField(default=True)
       expires_at = DateTimeField(null=True) # Optional expiration
   ```

2. **`src/core/migrations/XXXX_add_authcode_apikey_models.py`** - Django migration

3. **`src/api/services/auth_code_service.py`** - Auth code business logic
   - `create_auth_code(user_id, device_info) -> AuthCode`
   - `verify_auth_code(telegram_id, code) -> User | None`
   - `cleanup_expired_codes()` - Cron job to delete old codes

4. **`src/api/dependencies/api_key.py`** - API Key validation
   - `verify_api_key(key: str) -> User` - Validates key, returns user
   - `get_api_key_user(x_api_key: str = Header(...)) -> User` - FastAPI dependency

### Modified Files

1. **`src/api/v1/routers/auth.py`** - New secure login endpoints
   - `POST /v1/auth/request-code` - Request auth code (sends to Telegram)
   - `POST /v1/auth/verify-code` - Exchange code for JWT tokens
   - Keep existing `/login` but mark as deprecated or internal-only

2. **`src/api/dependencies/auth.py`** - Add combined auth dependency
   - `get_current_user_flexible()` - Accepts JWT OR API Key
   - Check `Authorization: Bearer` header first, then `X-API-Key` header

3. **`src/api/v1/routers/habits.py`** - Update auth dependency
   - Change from `get_current_active_user` to `get_current_user_flexible`
   - Allows both JWT and API Key authentication

4. **`src/bot/handlers/auth_handler.py`** - New handler for auth code delivery
   - Receives notification when code is requested
   - Sends code to user via Telegram message
   - Shows device info for security awareness

5. **`src/bot/handlers/settings_handler.py`** - Add API key management
   - Menu option to manage API keys
   - Create new key (show ONCE)
   - List active keys (names, dates, last used)
   - Revoke key

6. **`src/bot/messages.py`** - Add new messages
   - Auth code: `AUTH_CODE_MESSAGE`, `AUTH_CODE_DEVICE`, `AUTH_CODE_EXPIRES`, `AUTH_CODE_WARNING`
   - API keys: `API_KEY_GENERATED`, `API_KEY_LIST`, `API_KEY_REVOKED`, `API_KEY_EMPTY`

7. **`src/core/repositories.py`** - Add repositories
   - `AuthCodeRepository`: `create()`, `get_valid_code()`, `mark_used()`, `delete_expired()`
   - `APIKeyRepository`: `create()`, `get_by_key_hash()`, `list_by_user()`, `revoke()`, `update_last_used()`

## Security Design

### Auth Code Flow (Secure)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web/Mobile â”‚         â”‚  API Server â”‚         â”‚ Telegram Botâ”‚
â”‚     App     â”‚         â”‚             â”‚         â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚                       â”‚
       â”‚ 1. POST /auth/request-code                    â”‚
       â”‚    {telegram_id: "123", device: "iPhone"}     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚ 2. Generate 6-digit code
       â”‚                       â”‚    Store with 5min expiry
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚ 3. Send code via bot  â”‚
       â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚ 4. Deliver to user
       â”‚                       â”‚                       â”‚    "Code: 847291"
       â”‚                       â”‚                       â”‚    "Device: iPhone"
       â”‚   200 OK              â”‚                       â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
       â”‚   {message: "Code sent"}                      â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚                       â”‚
       â”‚ 5. User sees code in Telegram                 â”‚
       â”‚    and enters it in app                       â”‚
       â”‚                       â”‚                       â”‚
       â”‚ 6. POST /auth/verify-code                     â”‚
       â”‚    {telegram_id: "123", code: "847291"}       â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚ 7. Validate code:
       â”‚                       â”‚    - Exists?
       â”‚                       â”‚    - Not expired?
       â”‚                       â”‚    - Not used?
       â”‚                       â”‚    - Matches user?
       â”‚                       â”‚                       â”‚
       â”‚   200 OK              â”‚ 8. Mark code as used  â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
       â”‚   {access_token, refresh_token}               â”‚
       â”‚                       â”‚                       â”‚
```

### Code Generation
- 6-digit numeric code (000000-999999)
- Generated using `secrets.randbelow(1000000)`
- Padded with zeros: `str(code).zfill(6)`
- Easy to type on mobile keyboards

### Code Security
- **5-minute expiration** - Short window limits brute force
- **Single use** - Code is marked used after successful verification
- **Rate limiting** - Max 3 code requests per hour per user
- **Brute force protection** - Max 5 failed attempts, then block for 15 min
- **No user enumeration** - Same response whether user exists or not

### Why Auth Code is Secure
| Attack | Mitigation |
|--------|------------|
| Attacker knows telegram_id | Can't get code without access to victim's Telegram |
| Brute force 6-digit code | 5-min expiry + rate limiting = ~15 attempts max |
| Code interception | User sees device info, can detect suspicious logins |
| Replay attack | Single-use codes, marked as used after verification |

---

## API Key Authentication (for Automated Integrations)

### API Key Generation
1. Generate 32-byte random key using `secrets.token_urlsafe(32)`
2. Store SHA256 hash in database (never plaintext)
3. Show plaintext key to user ONCE during generation
4. Key format: `hrk_` prefix + 43 chars = `hrk_AbC123...` (total ~47 chars)

### API Key Flow
```
Fitness App                     API Server
    â”‚                               â”‚
    â”‚  X-API-Key: hrk_xxx...        â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                               â”‚ 1. Extract key from header
    â”‚                               â”‚ 2. SHA256 hash the key
    â”‚                               â”‚ 3. Lookup hash in api_keys table
    â”‚                               â”‚ 4. Verify is_active=True
    â”‚                               â”‚ 5. Check expires_at (if set)
    â”‚                               â”‚ 6. Update last_used_at
    â”‚                               â”‚ 7. Return associated User
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚  200 OK + JSON response       â”‚
```

### Why API Key is Secure
| Attack | Mitigation |
|--------|------------|
| Key theft | User can revoke key anytime via Telegram bot |
| Key guessing | 256-bit entropy (secrets.token_urlsafe(32)) |
| Key leak in logs | Key is hashed; logs only show `hrk_***` |
| Unauthorized access | Each key tied to single user; ownership enforced |

### Combined Authentication Dependency

```python
async def get_current_user_flexible(
    credentials: HTTPAuthorizationCredentials | None = Depends(security_scheme),
    x_api_key: str | None = Header(default=None)
) -> User:
    # Priority 1: JWT Bearer token
    if credentials and credentials.credentials:
        return await get_current_user(credentials)

    # Priority 2: API Key
    if x_api_key:
        return await get_api_key_user(x_api_key)

    # No auth provided
    raise UnauthorizedException(
        message="Authentication required (JWT or API Key)",
        code="AUTH_REQUIRED"
    )
```

---

## API Endpoints

### Request Auth Code
```
POST /v1/auth/request-code
Content-Type: application/json

{
  "telegram_id": "123456789",
  "device_info": "iPhone 15 Pro"  // optional
}

Response 200:
{
  "message": "If the account exists, a code was sent to Telegram",
  "expires_in_seconds": 300
}

Response 429 (rate limited):
{
  "error": {"code": "RATE_LIMITED", "message": "Too many requests. Try again in 45 minutes."}
}
```

### Verify Auth Code
```
POST /v1/auth/verify-code
Content-Type: application/json

{
  "telegram_id": "123456789",
  "code": "847291"
}

Response 200:
{
  "access_token": "eyJ...",
  "refresh_token": "eyJ...",
  "token_type": "bearer"
}

Response 401 (invalid/expired code):
{
  "error": {"code": "INVALID_CODE", "message": "Invalid or expired code"}
}

Response 429 (too many failed attempts):
{
  "error": {"code": "TOO_MANY_ATTEMPTS", "message": "Too many failed attempts. Try again in 15 minutes."}
}
```

## Telegram Bot Message

When user requests a code, they receive in Telegram:

```
ðŸ” Login Code: 847291

Device: iPhone 15 Pro
Expires in 5 minutes

âš ï¸ If you didn't request this code, ignore this message.
Someone may be trying to access your account.
```

## Usage Example (Web/Mobile App)

```javascript
// 1. Request code
const requestResponse = await fetch('/v1/auth/request-code', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    telegram_id: '123456789',
    device_info: 'Safari on macOS'
  })
});

// 2. Show UI: "Check Telegram for your code"
// 3. User enters code from Telegram

// 4. Verify code
const verifyResponse = await fetch('/v1/auth/verify-code', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    telegram_id: '123456789',
    code: userEnteredCode
  })
});

const {access_token, refresh_token} = await verifyResponse.json();

// 5. Store tokens, use for API calls
localStorage.setItem('access_token', access_token);
```

## Bot UI for API Key Management

### Menu Flow
```
/settings
  â””â”€â”€ ðŸ”‘ API Keys
        â”œâ”€â”€ âž• Create New Key
        â”‚     â””â”€â”€ Enter name: "Fitness App"
        â”‚     â””â”€â”€ âœ… Key generated! (show key ONCE)
        â”‚         hrk_AbC123...XyZ789
        â”‚         âš ï¸ Copy now - you won't see it again!
        â”‚
        â”œâ”€â”€ ðŸ“‹ List Keys
        â”‚     â””â”€â”€ "Fitness App" - Created: 01 Jan 2026, Last used: 5 min ago
        â”‚     â””â”€â”€ "iOS Shortcut" - Created: 15 Dec 2025, Last used: never
        â”‚
        â””â”€â”€ âŒ Revoke Key
              â””â”€â”€ Select key to revoke
              â””â”€â”€ âœ… Key "Fitness App" revoked
```

### Conversation Handler States
- `AWAITING_KEY_NAME` - User entering key name
- `SHOWING_KEY` - Display generated key
- `SELECTING_KEY_TO_REVOKE` - Choose key to revoke

---

## Usage Examples

### Fitness App Integration (API Key)
```python
import requests

# One-time setup: User copied API key from Telegram bot
API_KEY = "hrk_AbC123...XyZ789"

def complete_daily_fitness_habit():
    response = requests.post(
        "https://habitreward.org/v1/habits/5/complete",
        headers={
            "X-API-Key": API_KEY,
            "Content-Type": "application/json"
        },
        json={"target_date": None}  # today
    )
    return response.json()

# Called automatically when user completes daily fitness goal
result = complete_daily_fitness_habit()
print(f"Streak: {result['streak_count']}")
```

### iOS Shortcut (API Key)
```
URL: https://habitreward.org/v1/habits/5/complete
Method: POST
Headers:
  X-API-Key: hrk_AbC123...
  Content-Type: application/json
Body: {"target_date": null}
```

### Web/Mobile App Login (Auth Code)
```javascript
// 1. Request code
await fetch('/v1/auth/request-code', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    telegram_id: '123456789',
    device_info: 'Safari on macOS'
  })
});

// 2. User checks Telegram, enters code
const code = prompt("Enter code from Telegram:");

// 3. Verify code, get tokens
const {access_token} = await fetch('/v1/auth/verify-code', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    telegram_id: '123456789',
    code: code
  })
}).then(r => r.json());

// 4. Use token for API calls
await fetch('/v1/habits/5/complete', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${access_token}`,
    'Content-Type': 'application/json'
  },
  json: {}
});
```

---

## Unit Tests

### Test File: `tests/api/test_auth_code.py`

1. **Code Generation**
   - TC1: Code is 6 digits
   - TC2: Code expires after 5 minutes
   - TC3: Rate limiting after 3 requests/hour

2. **Code Verification**
   - TC4: Valid code returns tokens
   - TC5: Expired code returns 401
   - TC6: Already used code returns 401
   - TC7: Wrong code returns 401
   - TC8: Code for different user returns 401

3. **Brute Force Protection**
   - TC9: 5 failed attempts blocks for 15 min
   - TC10: Successful login resets attempt counter

4. **Telegram Delivery**
   - TC11: Code is sent via Telegram bot
   - TC12: Device info is included in message

5. **Edge Cases**
   - TC13: User not found returns same response (no enumeration)
   - TC14: Inactive user cannot request code
   - TC15: Concurrent code requests invalidate previous codes

### Test File: `tests/api/test_api_key_auth.py`

1. **API Key Generation**
   - TC16: Key has `hrk_` prefix
   - TC17: Key is hashed in database (plaintext not stored)
   - TC18: Same key string hashes to same value

2. **API Key Authentication**
   - TC19: Valid API key returns user
   - TC20: Invalid key returns 401
   - TC21: Expired key returns 401
   - TC22: Revoked (is_active=False) key returns 401
   - TC23: Missing key returns 401

3. **Combined Auth**
   - TC24: JWT takes priority when both present
   - TC25: API key works when JWT missing
   - TC26: Neither present returns 401

4. **Habit Completion with API Key**
   - TC27: Complete habit with valid API key succeeds
   - TC28: Complete habit with invalid API key fails
   - TC29: Cannot complete another user's habit (403)

5. **Bot Commands**
   - TC30: Generate key shows key once
   - TC31: List keys shows names but not keys
   - TC32: Revoke key sets is_active=False

---

## Migration Notes

- Keep existing `POST /v1/auth/login` temporarily for backward compatibility
- Mark it as deprecated in OpenAPI docs
- Remove after all clients migrate to new flow
