# Feature 0019: Custom Admin Action for Habit Log Reversion

## Context
Currently, administrators can manually delete HabitLog entries in Django Admin, but this does not trigger the proper reversion logic that rolls back associated reward progress. This can lead to data inconsistencies where a user's reward progress remains inflated even after a habit log is removed. To maintain data integrity, we need a custom admin action that properly reverts habit logs using the existing `habit_service.revert_habit_completion()` method.

## Technical Requirements

### 1. Admin Layer Changes

#### `src/core/admin.py` (HabitLogAdmin class, lines 143-168)

Add a custom admin action `revert_selected_logs` that:
1. Iterates through selected HabitLog objects
2. For each log, calls `habit_service.revert_habit_completion(user_telegram_id, habit_id)`
3. Handles errors gracefully and reports results via Django messages
4. Uses atomic transactions to ensure consistency

**Implementation Details:**

**Method signature:**
```python
@admin.action(description='Revert selected habit logs (and reward progress)')
def revert_selected_logs(self, request, queryset):
    """Custom admin action to properly revert habit logs."""
```

**Algorithm:**
1. Use `queryset.select_related('user', 'habit', 'reward')` to optimize queries
2. Iterate through each selected HabitLog:
   a. Extract `user.telegram_id` and `habit.id`
   b. Call `habit_service.revert_habit_completion(telegram_id, habit_id)`
   c. Catch `ValueError` exceptions (e.g., "No habit completion found to revert")
   d. Track success/failure counts
3. Display results using `self.message_user()`:
   - Success: `f"Successfully reverted {success_count} habit log(s)."`
   - Partial failure: `f"Reverted {success_count} log(s). Failed: {failed_count}."`
   - Total failure: `f"Failed to revert all {failed_count} log(s)."`
4. Use `messages.SUCCESS` for full success, `messages.WARNING` for partial, `messages.ERROR` for total failure

**Error Handling:**
- If `habit_service.revert_habit_completion()` raises `ValueError`:
  - Log the error with habit name and user telegram_id
  - Continue processing remaining logs (don't fail entire batch)
  - Include error details in admin message
- If log has no associated user or habit (data corruption):
  - Skip the log and report as failed
  - Log warning message

**Import Requirements:**
```python
from django.contrib import admin, messages
from src.services.habit_service import habit_service
from src.utils.async_compat import maybe_await
import asyncio
```

**Async Compatibility:**
Since `habit_service.revert_habit_completion()` returns `HabitRevertResult | Awaitable[HabitRevertResult]`, use:
- `asyncio.run()` to handle the async execution in the admin action
- Wrap the entire operation in a sync context
- Pattern: `asyncio.run(maybe_await(habit_service.revert_habit_completion(...)))`

**Register the action:**
Add `actions = ['revert_selected_logs']` to the HabitLogAdmin class.

### 2. Files to Modify

#### `src/core/admin.py`
- **Line 143**: Add `actions = ['revert_selected_logs']` to HabitLogAdmin
- **After line 167**: Add new method `revert_selected_logs()` (approximately 40-50 lines)

**Required imports** (add to top of file if not present):
- `from django.contrib import messages` (likely already imported)
- `from src.services.habit_service import habit_service`
- `from src.utils.async_compat import maybe_await`
- `import asyncio`
- `import logging`

### 3. Testing Strategy

Manual testing in Django Admin:
1. Create test habit logs with rewards
2. Verify reward progress is incremented
3. Select logs in admin interface
4. Run "Revert selected habit logs" action
5. Verify:
   - Logs are deleted
   - Reward progress is decremented
   - Success message displayed
6. Test error cases:
   - Revert same log twice (should fail gracefully)
   - Revert log for inactive user
   - Revert multiple logs (batch operation)

Unit testing in `tests/test_admin_actions.py` (new file):
1. Test successful single log reversion
2. Test batch reversion of multiple logs
3. Test partial failure (some logs fail to revert)
4. Test error handling for missing user
5. Test error handling for missing habit
6. Test error handling for already-reverted log
7. Verify audit log entries are created

### 4. Why This Approach

**Reuses existing business logic:**
- `habit_service.revert_habit_completion()` already handles:
  - Atomic transaction wrapper via `_revert_log_transaction()`
  - Reward progress rollback via `reward_progress_repo.decrement_pieces_earned()`
  - Audit log creation via `audit_log_service.log_reward_revert()`
  - Validation (user exists, habit exists, log exists)
- No need to duplicate this complex logic in admin layer

**Maintains data integrity:**
- Prevents orphaned reward progress when logs are deleted
- Ensures audit trail is maintained
- Uses same transaction logic as bot revert feature

**User safety:**
- Admin action requires explicit selection (no accidental bulk deletes)
- Clear success/failure messages guide administrators
- Errors don't cascade to entire batch

## Implementation Notes

**Execution Context:**
Django admin actions run in synchronous context, but `habit_service.revert_habit_completion()` can be async. Use `asyncio.run(maybe_await(...))` pattern to bridge sync/async boundary safely.

**Performance Consideration:**
For large batches (100+ logs), consider adding:
- Progress indicator (not built into Django admin actions)
- Batch size limit (warn if >50 logs selected)
- Optimization via `select_related()` to reduce query count

**Alternative Considered:**
Overriding `HabitLogAdmin.delete_queryset()` to automatically call revert logic on bulk delete was considered but rejected because:
- Less explicit (admins might not realize logs are being reverted, not just deleted)
- Custom actions provide clearer user intent and feedback
- Allows future addition of other custom actions without conflicting with delete behavior
