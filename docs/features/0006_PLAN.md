# Feature 0006: Language Selection Settings Menu

## Overview

Add a user-facing settings menu accessible via `/settings` command that allows users to manually change their language preference. The feature includes a settings menu screen with a "Select Language" option, and a language selection screen with three language options (English, Kazakh, Russian) displayed with flag emojis. Language selection takes immediate effect and updates the user's language preference in the database.

## User Flow

1. User types `/settings` command
2. Bot displays settings menu with inline keyboard containing "Select Language" button
3. User taps "Select Language"
4. Bot displays language selection screen with three inline buttons:
   - ğŸ‡¬ğŸ‡§ English
   - ğŸ‡°ğŸ‡¿ ÒšĞ°Ğ·Ğ°Ò›ÑˆĞ° (Kazakh)
   - ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹ (Russian)
   - "â† Back to Settings" button
5. User taps a language button (e.g., "ğŸ‡¬ğŸ‡§ English")
6. Bot immediately:
   - Updates user's language preference in User table
   - Returns to settings menu (message updates to show settings menu in newly selected language)
7. User can tap "â† Back to Settings" to return to settings menu without changing language

## Files to Modify

### 1. Bot Handlers - Create New Settings Handler
**File**: `src/bot/handlers/settings_handler.py` (NEW FILE)

Create new handler module with two callback handlers:
- `settings_command(update, context)` - Entry point for `/settings` command
  - Validates user exists and is active (standard pattern)
  - Gets user's current language
  - Displays settings menu with inline keyboard
  - Returns `AWAITING_SETTINGS_SELECTION` state

- `select_language_callback(update, context)` - Handles "Select Language" button
  - Callback pattern: `"settings_language"`
  - Edits message to show language selection keyboard
  - Returns `AWAITING_LANGUAGE_SELECTION` state

- `change_language_callback(update, context)` - Handles language selection buttons
  - Callback pattern: `"lang_en"`, `"lang_kk"`, `"lang_ru"`
  - Extracts language code from callback data (e.g., `callback_data.replace("lang_", "")`)
  - Calls `set_user_language(telegram_id, language_code)` from language module
  - Edits message to show settings menu in newly selected language
  - Returns `AWAITING_SETTINGS_SELECTION` state

- `back_to_settings_callback(update, context)` - Handles "Back to Settings" button
  - Callback pattern: `"settings_back"`
  - Edits message to show settings menu
  - Returns `AWAITING_SETTINGS_SELECTION` state

Conversation handler setup:
```python
settings_conversation = ConversationHandler(
    entry_points=[CommandHandler("settings", settings_command)],
    states={
        AWAITING_SETTINGS_SELECTION: [
            CallbackQueryHandler(select_language_callback, pattern="^settings_language$")
        ],
        AWAITING_LANGUAGE_SELECTION: [
            CallbackQueryHandler(change_language_callback, pattern="^lang_(en|kk|ru)$"),
            CallbackQueryHandler(back_to_settings_callback, pattern="^settings_back$")
        ]
    },
    fallbacks=[]
)
```

**Logging requirements**:
- ğŸ“¨ Log incoming `/settings` command with user context
- ğŸ–±ï¸ Log all button clicks (select language, language selection, back button)
- âœ… Log successful language changes with old and new language
- ğŸ“¤ Log all message edits

### 2. Keyboard Builder - Add Settings Keyboards
**File**: `src/bot/keyboards.py`

Add two new keyboard builder functions:

**Function**: `build_settings_keyboard(language: str) -> InlineKeyboardMarkup`
- Creates inline keyboard with single button: "Select Language" / "Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑĞ·Ñ‹Ğº" / "Ğ¢Ñ–Ğ»Ğ´Ñ– Ñ‚Ğ°Ò£Ğ´Ğ°Ñƒ"
- Callback data: `"settings_language"`
- Button text should be translated based on `language` parameter

**Function**: `build_language_selection_keyboard(language: str) -> InlineKeyboardMarkup`
- Creates inline keyboard with four buttons arranged vertically:
  1. "ğŸ‡¬ğŸ‡§ English" - callback: `"lang_en"`
  2. "ğŸ‡°ğŸ‡¿ ÒšĞ°Ğ·Ğ°Ò›ÑˆĞ°" - callback: `"lang_kk"`
  3. "ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹" - callback: `"lang_ru"`
  4. "â† Back to Settings" / "â† ĞĞ°Ğ·Ğ°Ğ´ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸" / "â† ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ»ĞµÑ€Ğ³Ğµ Ğ¾Ñ€Ğ°Ğ»Ñƒ" - callback: `"settings_back"`
- Back button text should be translated based on `language` parameter
- Language names should NOT be translated (always show native language name)

### 3. Message Constants - Add Settings Messages
**File**: `src/bot/messages.py`

Add new message constants to `Messages` class:

```python
# Settings menu
SETTINGS_MENU = "âš™ï¸ <b>Settings</b>\n\nSelect an option:"
SETTINGS_SELECT_LANGUAGE = "ğŸŒ Select Language"
SETTINGS_BACK = "â† Back to Settings"

# Language selection
LANGUAGE_SELECTION_MENU = "ğŸŒ <b>Select Language</b>\n\nChoose your preferred language:"
```

Add translations to `_TRANSLATIONS` dictionary:

```python
'ru': {
    'SETTINGS_MENU': "âš™ï¸ <b>ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</b>\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ñ†Ğ¸Ñ:",
    'SETTINGS_SELECT_LANGUAGE': "ğŸŒ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑĞ·Ñ‹Ğº",
    'SETTINGS_BACK': "â† ĞĞ°Ğ·Ğ°Ğ´ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸",
    'LANGUAGE_SELECTION_MENU': "ğŸŒ <b>Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑĞ·Ñ‹Ğº</b>\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ñ‹Ğ¹ ÑĞ·Ñ‹Ğº:"
},
'kk': {
    'SETTINGS_MENU': "âš™ï¸ <b>ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ»ĞµÑ€</b>\n\nĞĞ¿Ñ†Ğ¸ÑĞ½Ñ‹ Ñ‚Ğ°Ò£Ğ´Ğ°Ò£Ñ‹Ğ·:",
    'SETTINGS_SELECT_LANGUAGE': "ğŸŒ Ğ¢Ñ–Ğ»Ğ´Ñ– Ñ‚Ğ°Ò£Ğ´Ğ°Ñƒ",
    'SETTINGS_BACK': "â† ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ»ĞµÑ€Ğ³Ğµ Ğ¾Ñ€Ğ°Ğ»Ñƒ",
    'LANGUAGE_SELECTION_MENU': "ğŸŒ <b>Ğ¢Ñ–Ğ»Ğ´Ñ– Ñ‚Ğ°Ò£Ğ´Ğ°Ñƒ</b>\n\nÒšĞ°Ğ»Ğ°Ò“Ğ°Ğ½ Ñ‚Ñ–Ğ»Ñ–Ò£Ñ–Ğ·Ğ´Ñ– Ñ‚Ğ°Ò£Ğ´Ğ°Ò£Ñ‹Ğ·:"
}
```

### 4. Bot Main - Register Settings Handler
**File**: `src/bot/main.py`

Add import:
```python
from src.bot.handlers.settings_handler import settings_conversation
```

Register conversation handler:
```python
application.add_handler(settings_conversation)
```

Add `/settings` to help command description (both in code and in `HELP_TEXT` message constant)

### 5. Language Module - Verify set_user_language Implementation
**File**: `src/bot/language.py`

Verify existing `set_user_language(telegram_id: str, language_code: str)` function:
- Should validate language_code against supported languages
- Should update user record via `user_repository.update()`
- Should return success/failure status
- If function doesn't exist or is incomplete, implement it

Expected implementation:
```python
def set_user_language(telegram_id: str, language_code: str) -> bool:
    """Update user's language preference."""
    from src.config import get_settings
    from src.airtable.repositories import user_repository

    settings = get_settings()

    # Validate language code
    if language_code not in settings.supported_languages:
        logger.warning(f"Invalid language code: {language_code}")
        return False

    # Get user
    user = user_repository.get_by_telegram_id(telegram_id)
    if not user:
        logger.error(f"User not found: {telegram_id}")
        return False

    # Update user language
    user.language = language_code
    updated_user = user_repository.update(user)

    logger.info(f"Updated language for user {telegram_id} to {language_code}")
    return updated_user is not None
```

## Data Model Changes

**No database schema changes required** - the User model already has a `language` field (see `src/models/user.py:10`):
```python
language: str = Field(default='en')  # Multi-lingual support (ISO 639-1)
```

## Implementation Details

### Conversation States
Define two new conversation states in `settings_handler.py`:
```python
AWAITING_SETTINGS_SELECTION = 1
AWAITING_LANGUAGE_SELECTION = 2
```

### Callback Data Patterns
- Settings menu: `"settings_language"`
- Language selection: `"lang_en"`, `"lang_kk"`, `"lang_ru"`
- Back button: `"settings_back"`

### User Validation
Follow standard user validation pattern (see RULES.md):
- Check user exists: `user_repository.get_by_telegram_id(telegram_id)`
- Check user is active: `user.active`
- Use message constants: `msg('ERROR_USER_NOT_FOUND', lang)`, `msg('ERROR_USER_INACTIVE', lang)`

### Message Editing Pattern
Use `query.edit_message_text()` for all navigation:
```python
await query.edit_message_text(
    text=msg('SETTINGS_MENU', lang),
    reply_markup=build_settings_keyboard(lang),
    parse_mode="HTML"
)
```

### Logging Pattern
Follow emoji logging pattern (see RULES.md lines 268-289):
- ğŸ“¨ - Incoming `/settings` command
- ğŸ–±ï¸ - Button clicks (select language, language buttons, back)
- ğŸŒ - Language change operation
- âœ… - Successful language update
- âŒ - Failed language update
- ğŸ“¤ - Outgoing message/edit

Example:
```python
logger.info(f"ğŸ“¨ Received /settings from user {telegram_id} (@{username})")
logger.info(f"ğŸ–±ï¸ User {telegram_id} tapped 'Select Language' button")
logger.info(f"ğŸŒ User {telegram_id} selected language: {language_code}")
logger.info(f"âœ… Language updated successfully for user {telegram_id}: {old_lang} â†’ {new_lang}")
```

## Future Extensibility

The settings menu is designed to be extensible for future settings options:
- Add new buttons to `build_settings_keyboard()` for additional settings
- Add new callback handlers to `AWAITING_SETTINGS_SELECTION` state
- Examples of future settings:
  - Notification preferences
  - Timezone selection
  - Display preferences (emoji style, date format)
  - Privacy settings

## Testing Checklist

Manual testing scenarios:
1. New user runs `/settings` â†’ sees settings menu in their default language
2. User taps "Select Language" â†’ sees three language options with flags
3. User selects "ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹" â†’ menu updates to Russian immediately
4. User taps "â† ĞĞ°Ğ·Ğ°Ğ´ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸" â†’ returns to settings menu in Russian
5. User selects "ğŸ‡¬ğŸ‡§ English" â†’ menu updates back to English
6. User closes menu and runs `/help` â†’ help text displays in last selected language
7. Inactive user runs `/settings` â†’ receives "account not active" error
8. Unregistered user runs `/settings` â†’ receives "user not found" error

Verify language persistence:
- Change language, restart bot, run `/help` â†’ language persisted
- Change language, complete habit â†’ success message in new language
- Change language, claim reward â†’ reward messages in new language

## Files Created/Modified Summary

**New Files**:
- `src/bot/handlers/settings_handler.py` - Settings menu and language selection handlers

**Modified Files**:
- `src/bot/keyboards.py` - Add `build_settings_keyboard()` and `build_language_selection_keyboard()`
- `src/bot/messages.py` - Add settings-related message constants and translations
- `src/bot/main.py` - Register settings conversation handler and update help text
- `src/bot/language.py` - Verify/implement `set_user_language()` function (if needed)

**No Changes Required**:
- `src/models/user.py` - Language field already exists
- `src/airtable/repositories.py` - UserRepository already supports language field updates
- Airtable schema - No schema changes needed
