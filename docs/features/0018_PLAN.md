# Feature 0018: Skip Button in Edit Habit Flow

## Description
When editing a habit, users can skip individual fields to keep existing values instead of re-entering or re-selecting them. This allows editing only specific fields (e.g., just the name) without going through all steps.

## Implementation Status
✅ **IMPLEMENTED** - Skip functionality is fully implemented across all edit steps.

## Current Implementation

### Files Modified

#### 1. `src/bot/keyboards.py`

**`build_skip_cancel_keyboard(language, skip_callback)`** (lines 438-461)
- Returns keyboard with Skip and Cancel buttons
- Used for text input steps (Name field)
- Skip button uses `BUTTON_SKIP` translation

**`build_weight_selection_keyboard(current_weight, language, skip_callback)`** (lines 218-272)
- Accepts optional `skip_callback` parameter
- Adds Skip button when `skip_callback` is provided
- Skip button appears after weight options, before Cancel

**`build_category_selection_keyboard(current_category, language, skip_callback)`** (lines 276-322)
- Accepts optional `skip_callback` parameter
- Adds Skip button when `skip_callback` is provided

**`build_grace_days_keyboard(current_grace_days, language, skip_callback)`** (lines 750-798)
- Accepts optional `skip_callback` parameter
- Adds Skip button when `skip_callback` is provided

**`build_exempt_days_keyboard(current_exempt_days, language, skip_callback)`** (lines 801-858)
- Accepts optional `skip_callback` parameter
- Adds Skip button when `skip_callback` is provided

#### 2. `src/bot/handlers/habit_management_handler.py`

**Skip Handlers:**
- `habit_edit_name_skip()` (lines 753-781): Preserves old name, advances to weight selection
- `habit_edit_weight_skip()` (lines 828-856): Preserves old weight, advances to category selection
- `habit_edit_category_skip()` (lines 902-930): Preserves old category, advances to grace days selection
- `habit_edit_grace_days_skip()` (lines 971-1011): Preserves old grace days, advances to exempt days selection
- `habit_edit_exempt_days_skip()` (lines 1069-1128): Preserves old exempt days, advances to confirmation

**Conversation Handler Registration** (lines 1758-1783):
- All skip handlers registered with patterns: `skip_name`, `skip_weight`, `skip_category`, `skip_grace_days`, `skip_exempt_days`
- Skip buttons appear at each step of the edit flow

**Flow Integration:**
- `habit_edit_selected()` (line 742): Uses `build_skip_cancel_keyboard` for name input
- All selection keyboards called with `skip_callback` parameter set appropriately
- Each skip handler preserves old value in context and advances to next step

#### 3. `src/bot/messages.py`

**Translations:**
- `BUTTON_SKIP` defined in English (line 214): "⏭ Skip"
- Russian translation (line 433): "⏭ Пропустить"
- Kazakh translation (line 650): "⏭ Өткізу"
- All translations verified and complete

## Algorithm

**Skip Flow:**
1. User selects habit to edit → `habit_edit_selected()` stores old values in `context.user_data`
2. For each field (Name, Weight, Category, Grace Days, Exempt Days):
   - Keyboard displayed with Skip button (using `skip_callback` parameter)
   - If user clicks Skip → corresponding `habit_edit_*_skip()` handler:
     - Sets `new_habit_*` = `old_habit_*` in context
     - Advances to next conversation state
   - If user provides new value → normal handler stores new value and advances
3. After all fields → confirmation screen shows old vs new values
4. Skipped fields show same value for old and new in confirmation

## Unit Tests Required

### Test File: `tests/test_habit_edit_skip.py`

**Test Cases:**

1. **`test_habit_edit_name_skip()`**
   - Mocks habit with name "Test Habit"
   - Calls `habit_edit_name_skip()` handler
   - Verifies `context.user_data['new_habit_name'] == 'Test Habit'`
   - Verifies next state is `AWAITING_EDIT_WEIGHT`
   - Verifies weight selection keyboard shown with skip button

2. **`test_habit_edit_weight_skip()`**
   - Mocks habit with weight 30
   - Calls `habit_edit_weight_skip()` handler
   - Verifies `context.user_data['new_habit_weight'] == 30`
   - Verifies next state is `AWAITING_EDIT_CATEGORY`
   - Verifies category selection keyboard shown with skip button

3. **`test_habit_edit_category_skip()`**
   - Mocks habit with category "health"
   - Calls `habit_edit_category_skip()` handler
   - Verifies `context.user_data['new_habit_category'] == 'health'`
   - Verifies next state is `AWAITING_EDIT_GRACE_DAYS`

4. **`test_habit_edit_grace_days_skip()`**
   - Mocks habit with grace_days 2
   - Calls `habit_edit_grace_days_skip()` handler
   - Verifies `context.user_data['new_habit_grace_days'] == 2`
   - Verifies next state is `AWAITING_EDIT_EXEMPT_DAYS`

5. **`test_habit_edit_exempt_days_skip()`**
   - Mocks habit with exempt_days [6, 7]
   - Calls `habit_edit_exempt_days_skip()` handler
   - Verifies `context.user_data['new_habit_exempt_days'] == [6, 7]`
   - Verifies next state is `AWAITING_EDIT_CONFIRMATION`
   - Verifies confirmation message shows skipped fields match old values

6. **`test_skip_all_fields_preserves_original_values()`**
   - Mocks complete habit
   - Simulates skipping all fields
   - Verifies final confirmation shows all old == new values

7. **`test_skip_some_fields_mixed_with_changes()`**
   - Mocks habit
   - Skips name and weight, changes category
   - Verifies confirmation shows:
     - Name: old == new (skipped)
     - Weight: old == new (skipped)
     - Category: old != new (changed)

8. **`test_skip_button_translations()`**
   - Tests `build_skip_cancel_keyboard` with each language
   - Verifies Skip button text matches `BUTTON_SKIP` translation

9. **`test_keyboard_skip_callbacks()`**
   - Verifies each keyboard builder adds Skip button when `skip_callback` provided
   - Verifies Skip button callback_data matches expected pattern

## Files to Create/Modify

### New Files:
- `tests/test_habit_edit_skip.py` - Unit tests for skip functionality

### No Code Changes Required
- Implementation is complete
- All handlers properly registered
- Translations verified

