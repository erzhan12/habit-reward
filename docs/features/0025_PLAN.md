# Feature 0025: Recurring vs Non-Recurring Rewards

## Description

Add distinction between recurring and non-recurring rewards:
- **Recurring rewards** (e.g., massage): Can be claimed multiple times, remain active after claiming
- **Non-recurring rewards** (e.g., MacBook): Auto-deactivate after first claim, cannot be claimed again
- **Manual deactivation**: Users can manually deactivate/activate rewards from the Rewards menu

## Files to Modify

### 1. Model Layer

**`src/core/models.py`** - Add `is_recurring` field to Reward model:
```
Reward.is_recurring: BooleanField(default=True)
```
- Default `True` for backward compatibility (existing rewards behave as before)
- Add help_text explaining the field purpose

**`src/models/reward.py`** - Add `is_recurring` field to Pydantic model:
- Add `is_recurring: bool = Field(default=True, ...)`

### 2. Database Migration

Create migration to add `is_recurring` field:
- `python manage.py makemigrations core`
- Default value `True` ensures existing rewards continue to work
- **Migration Strategy**:
  - All existing rewards will default to `is_recurring=True` (backward compatible)
  - No data migration needed - existing behavior preserved
  - Migration should be reversible (rollback sets field to NULL, then removes column)

### 3. Service Layer

**`src/services/reward_service.py`**:

- **`mark_reward_claimed()`**: After resetting progress, check `is_recurring`:
  - If `is_recurring=False`: Set reward `active=False` (auto-deactivate)
  - If `is_recurring=True`: No change (current behavior)

- **`create_reward()`**: Accept optional `is_recurring` parameter (default `True`)

- Add new method **`toggle_reward_active(user_id, reward_id, active: bool)`**:
  - Validate user owns the reward (raise ValueError if not)
  - Validate reward exists (raise ValueError if not found)
  - Update `reward.active` to the new value
  - Save reward
  - Return updated reward
  - **Note**: No validation on `is_recurring` - users can toggle active status regardless of recurring setting

### 4. Bot Handlers

**`src/bot/handlers/reward_handlers.py`**:

#### Add Reward Flow
Add new conversation state `AWAITING_REWARD_RECURRING` after pieces selection:
- Prompt: "Is this reward recurring?"
- Options: "Yes (can claim multiple times)" / "No (one-time only)"
- Store choice in context: `reward_data['is_recurring']`
- Update `reward_confirm_save()` to pass `is_recurring` to service

#### Edit Reward Flow
Add `is_recurring` to the edit flow:
- Add prompt step between pieces and confirmation
- Show current value
- Allow skip to keep current value

#### New: Activate/Deactivate Flow
Add handlers for manual activation/deactivation:
- Entry from Rewards menu button "Activate/Deactivate Reward"
- Show list of all rewards (both active and inactive) with status indicators
- User selects reward ‚Üí toggle its active status
- Confirmation message with new status

**`src/bot/keyboards.py`**:
- Add `build_recurring_keyboard(lang)` - Yes/No buttons for recurring selection
- Add `build_rewards_for_toggle_keyboard(rewards, lang)` - List rewards with active status for toggle
  - Show all rewards (active and inactive) with status indicators
  - Format: "‚úÖ/‚ùå {reward_name} ({is_recurring indicator})"
  - Each button callback: `toggle_reward_{reward_id}`
- Update `build_rewards_menu_keyboard(lang)` - Add "Activate/Deactivate" button
  - Place after "Edit Reward" button
  - Callback: `menu_reward_toggle`

**`src/bot/messages.py`**:
- Add messages for recurring prompts:
  - `HELP_ADD_REWARD_RECURRING_PROMPT` - "Is this reward recurring? (Can be claimed multiple times)"
  - `HELP_EDIT_REWARD_RECURRING_PROMPT` - "Is this reward recurring? Current: {current_value}"
  - `BUTTON_RECURRING_YES` - "Yes (can claim multiple times)"
  - `BUTTON_RECURRING_NO` - "No (one-time only)"
- Add messages for activate/deactivate:
  - `HELP_TOGGLE_REWARD_SELECT` - "Select a reward to activate/deactivate:"
  - `SUCCESS_REWARD_ACTIVATED` - "‚úÖ Reward '{name}' is now active"
  - `SUCCESS_REWARD_DEACTIVATED` - "‚ùå Reward '{name}' is now inactive"
  - `ERROR_NO_REWARDS_TO_TOGGLE` - "You don't have any rewards to manage"
  - `INFO_REWARD_NON_RECURRING_DEACTIVATED` - "This reward is non-recurring and has been deactivated. You can reactivate it manually from the Rewards menu if needed."
- Add status indicators for reward lists:
  - `LABEL_REWARD_ACTIVE` - "‚úÖ Active"
  - `LABEL_REWARD_INACTIVE` - "‚ùå Inactive"
  - `LABEL_REWARD_NON_RECURRING` - "üîí One-time"
  - `LABEL_REWARD_RECURRING` - "üîÑ Recurring"

**`src/bot/formatters.py`**:

Update `format_rewards_list_message()`:
- Add status indicators for inactive rewards:
  - Active rewards: display normally
  - Inactive rewards: prefix with "‚ùå " or use strikethrough: `<s>{reward.name}</s>`
  - Show `is_recurring` indicator: "üîÑ" for recurring, "üîí" for non-recurring (optional, can be in details)
- Update to handle both active and inactive rewards when called from toggle flow
- Consider adding helper: `format_reward_status_indicator(reward, lang)` to standardize status display

Update `format_reward_progress_message()` (if exists):
- Show status indicator if reward is inactive
- Indicate if reward is non-recurring and claimed

### 5. REST API

**`src/api/v1/routers/rewards.py`**:

#### Response Models
Update `RewardResponse`:
- Add `is_recurring: bool` field

#### Request Models
Update `RewardCreateRequest`:
- Add `is_recurring: bool = Field(default=True)`

Update `RewardUpdateRequest`:
- Add `is_recurring: bool | None = None`

#### Endpoints
- `POST /v1/rewards`: Accept `is_recurring` in request body
- `PATCH /v1/rewards/{id}`: Accept `is_recurring` in request body
- `POST /v1/rewards/{id}/claim`:
  - After calling `mark_reward_claimed()`, reload reward and include updated `active` status in response
  - Response should indicate if reward was auto-deactivated

Add new endpoint:
- `POST /v1/rewards/{id}/toggle-active`: Toggle reward active status
  - Request: `{ "active": bool }` (optional, defaults to opposite of current)
  - Response: Updated reward with new active status
  - Validation: User must own the reward

### 6. Repository Layer

**`src/core/repositories.py`**:

Update `RewardRepository`:
- Add method `get_all(user_id)` to get ALL rewards (not just active) for toggle list
- The existing `get_all_active(user_id)` remains unchanged

### 7. Admin Interface

**`src/core/admin.py`**:

Update `RewardAdmin`:
- Add `is_recurring` to `list_display`: `['name', 'user', 'type', 'weight', 'pieces_required', 'piece_value', 'max_daily_claims', 'is_recurring', 'active', 'created_at']`
- Add `is_recurring` to `list_filter`: `['type', 'active', 'is_recurring', 'created_at', 'user']`
- Add `is_recurring` to fieldsets in "Reward Information" section
- Add help_text: "If True, reward can be claimed multiple times. If False, reward auto-deactivates after first claim."
- Make `is_recurring` editable in admin (not readonly)

## Algorithm: Claim Flow with Auto-Deactivation

```
1. User requests claim for reward_id
2. Service validates: reward exists, user owns it, status is ACHIEVED
3. Service calls mark_reward_claimed():
   a. Reset pieces_earned = 0
   b. Set claimed = True
   c. Check if reward.is_recurring == False:
      - If False: Set reward.active = False
4. Return updated progress
5. Bot/API shows success message
6. If non-recurring: Show additional message that reward is now inactive
```

## Algorithm: Manual Toggle

```
1. User opens Rewards menu ‚Üí selects "Activate/Deactivate"
2. Bot calls reward_repository.get_all(user_id) to get ALL rewards
3. If no rewards: Show ERROR_NO_REWARDS_TO_TOGGLE, return to menu
4. Show list of ALL rewards with status indicators:
   - Format: "‚úÖ/‚ùå {reward_name} (üîÑ Recurring / üîí One-time)"
   - Use build_rewards_for_toggle_keyboard()
5. User selects reward via inline button (callback: toggle_reward_{reward_id})
6. Bot handler calls reward_service.toggle_reward_active(user_id, reward_id, !current_active)
7. Service validates ownership, toggles status, saves
8. Bot shows confirmation: SUCCESS_REWARD_ACTIVATED or SUCCESS_REWARD_DEACTIVATED
9. Return to Rewards menu
```

## Algorithm: Reward Display in Lists

**Active Rewards List** (`/list_rewards` or "My Rewards"):
- Only show active rewards (existing behavior)
- No status indicators needed (all are active by definition)

**Toggle Rewards List** (Activate/Deactivate flow):
- Show ALL rewards (active and inactive)
- Format each: "{status_emoji} {name} ({recurring_indicator})"
- Status emoji: ‚úÖ for active, ‚ùå for inactive
- Recurring indicator: üîÑ for recurring, üîí for non-recurring

**Progress Display** (`/my_rewards`):
- Show progress for all rewards (active and inactive)
- If reward is inactive: prefix with "‚ùå " or show "(Inactive)" badge
- If non-recurring and claimed: show "(Claimed - One-time)" indicator

## Unit Tests

### `tests/test_reward_service.py`

Add test class `TestRecurringRewards`:

1. **`test_claim_recurring_reward_stays_active`**
   - Create reward with `is_recurring=True`
   - Set progress to ACHIEVED
   - Call `mark_reward_claimed()`
   - Assert: reward.active remains `True`

2. **`test_claim_non_recurring_reward_deactivates`**
   - Create reward with `is_recurring=False`
   - Set progress to ACHIEVED
   - Call `mark_reward_claimed()`
   - Assert: reward.active becomes `False`

3. **`test_create_reward_default_recurring`**
   - Call `create_reward()` without `is_recurring`
   - Assert: created reward has `is_recurring=True`

4. **`test_create_reward_explicit_non_recurring`**
   - Call `create_reward(is_recurring=False)`
   - Assert: created reward has `is_recurring=False`

5. **`test_toggle_reward_active`**
   - Create active reward
   - Call `toggle_reward_active(active=False)`
   - Assert: reward.active is `False`
   - Call `toggle_reward_active(active=True)`
   - Assert: reward.active is `True`

6. **`test_toggle_reward_wrong_user`**
   - Create reward for user A
   - Call `toggle_reward_active()` as user B
   - Assert: raises ValueError or appropriate error

### `tests/api/test_rewards.py`

Add test classes:

**`TestCreateRewardRecurring`**:

1. **`test_create_reward_default_recurring`**
   - POST without `is_recurring`
   - Assert: response has `is_recurring=True`

2. **`test_create_reward_explicit_non_recurring`**
   - POST with `is_recurring=False`
   - Assert: response has `is_recurring=False`

**`TestUpdateRewardRecurring`**:

1. **`test_update_reward_set_non_recurring`**
   - PATCH with `is_recurring=False`
   - Assert: updated reward has `is_recurring=False`

**`TestClaimRewardRecurring`**:

1. **`test_claim_recurring_reward_stays_active`**
   - Create recurring reward, achieve it
   - POST to `/claim`
   - Assert: reward.active is still `True`

2. **`test_claim_non_recurring_reward_deactivates`**
   - Create non-recurring reward, achieve it
   - POST to `/claim`
   - Assert: reward.active becomes `False`

**`TestToggleRewardActive`**:

1. **`test_toggle_reward_deactivate`**
   - POST to `/toggle-active` with `active=False`
   - Assert: reward.active is `False`

2. **`test_toggle_reward_activate`**
   - POST to `/toggle-active` with `active=True`
   - Assert: reward.active is `True`

3. **`test_toggle_reward_not_found`**
   - POST to `/toggle-active` for non-existent reward
   - Assert: 404 response

4. **`test_toggle_reward_forbidden`**
   - POST to `/toggle-active` for another user's reward
   - Assert: 403 response

### `tests/test_bot_handlers.py`

Add test class `TestRecurringRewardsBot`:

1. **`test_add_reward_recurring_flow`**
   - Simulate add reward conversation
   - Verify recurring prompt appears
   - Verify selection is stored and passed to service

2. **`test_claim_non_recurring_shows_deactivation_message`**
   - Create non-recurring reward, achieve it
   - Claim via bot command
   - Assert: success message + deactivation info message shown

3. **`test_toggle_reward_flow`**
   - Create reward, toggle via bot
   - Assert: confirmation message shown
   - Assert: reward status updated

4. **`test_toggle_reward_empty_list`**
   - User with no rewards tries to toggle
   - Assert: ERROR_NO_REWARDS_TO_TOGGLE shown

### `tests/test_formatters.py`

Add tests for reward display formatting:

1. **`test_format_rewards_list_with_inactive`**
   - Format list with active and inactive rewards
   - Assert: inactive rewards have status indicator

2. **`test_format_reward_status_indicator`**
   - Test status indicator formatting for various states

## Edge Cases to Handle

1. **Non-recurring reward claimed then reactivated manually**: User can manually reactivate a deactivated non-recurring reward. If they earn enough pieces again, they can claim it again (it will auto-deactivate again).

2. **Changing recurring to non-recurring on existing reward**: Allowed. If the reward is later claimed, it will deactivate. No validation needed - user can change this at any time.

3. **Changing non-recurring to recurring on claimed reward**: Allowed. User must manually reactivate if they want to use it again. No validation needed.

4. **Display in reward lists**:
   - Active rewards: shown normally
   - Inactive rewards: shown with indicator (e.g., strikethrough or "Inactive" badge)
   - Non-recurring claimed rewards: shown as "Claimed - Inactive"

5. **Toggle active status on non-recurring claimed reward**: Allowed. User can reactivate manually even after auto-deactivation. This allows flexibility (e.g., if user wants to "undo" a claim or reuse the reward).

6. **Empty reward list in toggle flow**: If user has no rewards, show ERROR_NO_REWARDS_TO_TOGGLE and return to menu gracefully.

7. **Concurrent claims**: If user claims non-recurring reward while another process is claiming it, ensure atomic update (Django's save() is atomic, but consider using select_for_update() if needed).

8. **Migration of existing data**: All existing rewards default to `is_recurring=True`, preserving current behavior. No user action required.

## Validation Rules

1. **`is_recurring` field**:
   - Must be boolean (True/False)
   - Default: True (for backward compatibility)
   - Can be changed at any time (no restrictions)

2. **`toggle_reward_active()`**:
   - User must own the reward (ownership validation)
   - Reward must exist (existence validation)
   - No restriction based on `is_recurring` status
   - No restriction based on current `active` status

3. **`mark_reward_claimed()`**:
   - Auto-deactivation only occurs if `is_recurring=False`
   - Auto-deactivation happens AFTER progress reset
   - No validation needed - service handles logic internally
