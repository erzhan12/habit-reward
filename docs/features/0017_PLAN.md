# Feature 0017: Flexible Streak Tracking with Grace Days

## Context
Users need more flexibility in maintaining habit streaks. Currently, a streak breaks if a habit is not completed every single day. This feature introduces "grace days" (allowing a configurable number of skipped days) and "exempt days" (days of the week like weekends that don't count against the streak), preventing demotivation from minor slips or planned breaks.

## Technical Requirements

### 1. Data Layer Changes

#### `src/core/models.py`
Modify the `Habit` model to include two new fields:
- `allowed_skip_days` (Integer): Number of consecutive days a user can skip without breaking the streak. Default: `0`.
- `exempt_weekdays` (JSONField or List[int]): List of days of the week (1=Mon, 7=Sun) that are exempt from streak breaking. Default: `[]`. (Alternatively, use a CSV string if JSONField is not preferred for the DB backend, but JSONField is standard for Django).

#### `src/models/habit.py`
Update the Pydantic `Habit` model to reflect these new fields for internal usage and API contracts.

### 2. Service Layer Changes

#### `src/services/streak_service.py`
Update `calculate_streak` (and potentially helper methods) to implement the flexible logic.

**Algorithm for `calculate_streak`:**
1. Fetch the last `HabitLog` for the user and habit.
2. If no log exists, return 1.
3. Calculate the date difference (`diff`) between `today` and `last_completed_date`.
4. If `diff` is 0 (done today): Return `last_log.streak_count`.
5. If `diff` is 1 (done yesterday): Return `last_log.streak_count + 1`.
6. If `diff > 1`:
   a. Identify all dates between `last_completed_date` and `today` (exclusive).
   b. Filter out any dates that fall on `exempt_weekdays`.
   c. Count the remaining "missed" days.
   d. If `missed_days <= allowed_skip_days`:
      - The streak is preserved. Return `last_log.streak_count + 1`.
   e. Else:
      - The streak is broken. Return 1.

**Note**: Ensure `exempt_weekdays` logic correctly handles the gap check. For example, if weekends are exempt and I last did it Friday, and today is Monday:
- Gap: Sat, Sun.
- Exempt: Sat (6), Sun (7).
- Missed count: 0.
- Result: Streak preserved.

### 3. Bot Layer Changes

#### `src/bot/handlers/habit_management_handler.py`
Update `add_habit_conversation` and `edit_habit_conversation` to include steps for setting these new parameters.

**Add Habit Flow:**
1. After `AWAITING_HABIT_CATEGORY`, add `AWAITING_GRACE_DAYS`.
   - Prompt: "How many grace days? (0 for strict)".
   - Input: Integer.
2. Add `AWAITING_EXEMPT_DAYS`.
   - Prompt: "Select exempt days (e.g., Weekends)".
   - Input: Interactive keyboard or comma-separated numbers.
   - Options: "None", "Weekends (Sat/Sun)". (Manual text input for custom days supported via prompt).

**Edit Habit Flow:**
- Add options to the edit menu to change "Grace Days" and "Exempt Days".
- Implement handlers for these new edit paths.

#### `src/bot/keyboards.py`
- Create `build_grace_days_keyboard` (presets: 0, 1, 2, 3).
- Create `build_exempt_days_keyboard` (presets: None, Weekends).

#### `src/bot/messages.py`
- Add messages for:
  - `HELP_ADD_HABIT_GRACE_DAYS_PROMPT`
  - `HELP_ADD_HABIT_EXEMPT_DAYS_PROMPT`
  - Validation errors (negative numbers, invalid days).
  - Confirmation summaries showing these new settings.

## Implementation Phases

### Phase 1: Data & Logic
1.  Add fields to `Habit` model in `src/core/models.py` and `src/models/habit.py`.
2.  Create and run migration.
3.  Update `src/services/streak_service.py` with the new calculation logic.
4.  Add unit tests in `tests/services/test_streak_service.py` to verify various scenarios (strict, grace days, exempt weekends).

### Phase 2: Bot UI
1.  Update `src/bot/messages.py` and `src/bot/keyboards.py`.
2.  Update `src/bot/handlers/habit_management_handler.py` to support the expanded flow for Add/Edit.
3.  Manual testing of the conversation flows.

