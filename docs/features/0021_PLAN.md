# Feature 0021: Split Habit Completion into Simple and Advanced Flows

## Overview

Split the current `/habit_done` flow into two separate flows:
1. **Simple flow** (default, top menu button): Shows only pending habits for today, one-click logging
2. **Advanced flow** (lower in menu): Shows all habits with date selection (Today/Yesterday/Select Date)

This optimizes for the 90% use case where users just want to mark a habit done for today.

## Current Implementation

### Flow
1. User clicks "Habit Done" in main menu (`menu_habit_done` callback)
2. `bridge_command_callback` routes to `menu_habit_done_show_habits` (menu_handler.py:374)
3. Shows ALL active habits via `build_habit_selection_keyboard`
4. User selects habit ‚Üí shows date options (Today/Yesterday/Select Date)
5. User selects date ‚Üí completion is logged

### Key Functions
- `menu_habit_done_show_habits` (menu_handler.py:374) - shows all habits
- `habit_selected_standalone_callback` (menu_handler.py:414) - shows date options after habit selection
- `menu_habit_today_callback` (menu_handler.py:472) - processes "Today" button
- `build_habit_selection_keyboard` (keyboards.py:10) - builds habit list keyboard
- `build_completion_date_options_keyboard` (keyboards.py:861) - builds date selection keyboard
- `get_active_habits_pending_for_today` (habit_service.py:599) - **already exists, returns habits not completed today**

## Implementation Plan

### Phase 1: New Simple Flow Handler (menu_handler.py)

#### 1.1 Add `menu_habit_done_simple_show_habits`
Location: `src/bot/handlers/menu_handler.py` (after line 412)

```
async def menu_habit_done_simple_show_habits(update, context):
    """Handle simple 'Habit Done' from menu - show only pending habits for immediate logging."""
```

Algorithm:
1. Get user by telegram_id
2. Call `habit_service.get_active_habits_pending_for_today(user.id)`
3. If empty ‚Üí show "all habits completed today" message with back button
4. Otherwise ‚Üí show pending habits with `build_simple_habit_selection_keyboard`

#### 1.2 Add `simple_habit_selected_callback`
Location: `src/bot/handlers/menu_handler.py` (after simple flow handler)

```
async def simple_habit_selected_callback(update, context):
    """Handle habit selection from simple flow - immediately log for today."""
```

Algorithm:
1. Extract habit_id from callback data (`simple_habit_{id}`)
2. Get habit name from ID
3. Call `habit_service.process_habit_completion(telegram_id, habit_name, target_date=None)`
4. Show completion message with back button

### Phase 2: New Keyboard Function (keyboards.py)

#### 2.1 Add `build_simple_habit_selection_keyboard`
Location: `src/bot/keyboards.py` (after `build_habit_selection_keyboard`)

```python
def build_simple_habit_selection_keyboard(habits: list[Habit], language: str = 'en') -> InlineKeyboardMarkup:
```

- Uses callback_data prefix `simple_habit_` to distinguish from advanced flow
- Each habit button ‚Üí immediate completion on click
- Includes "Back" button

### Phase 3: Menu Keyboard Updates (keyboards.py)

#### 3.1 Update `build_habits_menu_keyboard` (line 692)

**Implementation Decision**: The "Habit Done for Date" button was added to the **Habits submenu** instead of the main menu to keep the main menu cleaner and emphasize that date selection is an advanced/less common feature.

**Habits Submenu Layout**:
```
[Add Habit]
[Edit Habit]
[Remove Habit]
[Revert Habit]
[Habit Done for Date]           ‚Üê Advanced flow (new button, after Revert Habit)
[¬´ Back]
```

**Main Menu Layout** (unchanged):
```
[Habit Done]                    ‚Üê Simple flow (default, stays at top)
[Habits, Rewards]
[Add Habit, List Rewards]
[Streaks, Settings]
[Help, Close]
```

Add new callback data: `menu_habit_done_date` for advanced flow

### Phase 4: Messages (messages.py)

#### 4.1 Add New Message Keys

```python
# Simple flow messages
BUTTON_HABIT_DONE_DATE = "üìÖ Habit Done for Date"
HELP_SIMPLE_HABIT_SELECTION = "Which habit did you complete today? üéØ"

# Already exists: INFO_ALL_HABITS_COMPLETED
```

Add translations for `ru` and `kk`:
- `BUTTON_HABIT_DONE_DATE` ‚Üí "üìÖ –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞ –¥–∞—Ç—É" (ru) / "üìÖ –ö“Ø–Ω–≥–µ –±–µ–ª–≥—ñ–ª–µ—É" (kk)
- `HELP_SIMPLE_HABIT_SELECTION` ‚Üí "–ë“Ø–≥—ñ–Ω “õ–∞–π ”ô–¥–µ—Ç—Ç—ñ –æ—Ä—ã–Ω–¥–∞–¥—ã“£—ã–∑? üéØ" (kk) / "–ö–∞–∫—É—é –ø—Ä–∏–≤—ã—á–∫—É –≤—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è? üéØ" (ru)

### Phase 5: Handler Registration (menu_handler.py)

#### 5.1 Update `bridge_command_callback` mapping (line 257)

Change:
```python
'menu_habit_done': menu_habit_done_show_habits,
```

To:
```python
'menu_habit_done': menu_habit_done_simple_show_habits,  # Simple flow (default)
'menu_habit_done_date': menu_habit_done_show_habits,    # Advanced flow with date selection
```

#### 5.2 Update `get_menu_handlers` (line 838)

Add new callback handler:
```python
CallbackQueryHandler(simple_habit_selected_callback, pattern="^simple_habit_"),
```

This must be added BEFORE the existing `habit_selected_standalone_callback` pattern to ensure proper routing.

## Files to Modify

| File | Changes |
|------|---------|
| `src/bot/handlers/menu_handler.py` | Add `menu_habit_done_simple_show_habits`, `simple_habit_selected_callback`; update `bridge_command_callback` mapping; update `get_menu_handlers` |
| `src/bot/keyboards.py` | Add `build_simple_habit_selection_keyboard`; update `build_habits_menu_keyboard` layout (not main menu) |
| `src/bot/messages.py` | Add `BUTTON_HABIT_DONE_DATE`, `HELP_SIMPLE_HABIT_SELECTION` with translations |

## Callback Data Patterns

| Pattern | Flow | Handler |
|---------|------|---------|
| `menu_habit_done` | Simple | `menu_habit_done_simple_show_habits` |
| `simple_habit_{id}` | Simple | `simple_habit_selected_callback` |
| `menu_habit_done_date` | Advanced | `menu_habit_done_show_habits` (existing) |
| `habit_{id}` | Advanced | `habit_selected_standalone_callback` (existing) |
| `habit_{id}_today` | Advanced | `menu_habit_today_callback` (existing) |
| `habit_{id}_yesterday` | Advanced | `menu_habit_yesterday_callback` (existing) |

## User Flow Comparison

### Simple Flow (Default - Main Menu Top Button)
```
Main Menu ‚Üí [Habit Done] ‚Üí Shows pending habits only ‚Üí Click habit ‚Üí Done!
```
(3 taps total)

### Advanced Flow (Habits Submenu)
```
Main Menu ‚Üí [Habits] ‚Üí [Habit Done for Date] ‚Üí Shows ALL habits ‚Üí Select habit ‚Üí Select date ‚Üí Done
```
(5-6 taps total)

**Note**: The advanced flow requires one extra tap (opening Habits submenu) compared to the original plan, but this keeps the main menu cleaner and emphasizes that date selection is a less common, advanced feature.

## Edge Cases

1. **All habits completed today**: Show `INFO_ALL_HABITS_COMPLETED` message with back button
2. **No habits configured**: Show `ERROR_NO_HABITS` message (same as current)
3. **Habit completion fails**: Show error message with back button (existing error handling)

## Date Format Standardization

As part of this implementation, all date displays across the application were standardized to use the format: **"09 Dec 2025"** (format string: `"%d %b %Y"`)

### Files Updated for Date Format Consistency:
- `src/bot/handlers/menu_handler.py` - All date displays in menu flow handlers
- `src/bot/handlers/habit_done_handler.py` - Backdate and yesterday completion messages
- `src/bot/handlers/backdate_handler.py` - All backdate flow date displays

Previous format was `"%B %d, %Y"` which displayed as "December 09, 2025". The new format is more concise and internationally recognizable.

## Post-Implementation Bug Fixes

### Bug Fix: Simple Flow Empty Habit List Handling

**Issue**: Initial implementation of `menu_habit_done_simple_show_habits` would show "All habits completed today" message when a user had ZERO habits configured, misinforming new users.

**Root Cause**: The function only called `get_active_habits_pending_for_today()` which returns empty both when:
1. User has no habits configured (should show ERROR)
2. User has habits but all are completed today (should show SUCCESS)

**Fix Applied** (`src/bot/handlers/menu_handler.py:434-441`):
```python
# First check if user has any habits configured
all_habits = await maybe_await(habit_service.get_all_active_habits(user.id))
if not all_habits:
    await query.edit_message_text(
        msg('ERROR_NO_HABITS', lang),
        reply_markup=build_back_to_menu_keyboard(lang)
    )
    return 0

# Then check for pending habits...
habits = await maybe_await(habit_service.get_active_habits_pending_for_today(user.id))
if not habits:
    # All habits completed today (we know user has habits from check above)
    await query.edit_message_text(
        msg('INFO_ALL_HABITS_COMPLETED', lang),
        reply_markup=build_back_to_menu_keyboard(lang),
        parse_mode="HTML"
    )
    return 0
```

**Result**: Now correctly distinguishes between "no habits configured" and "all habits completed for today" scenarios.

**Unit Tests**: Added comprehensive test coverage in `tests/test_bot_handlers.py::TestSimpleHabitDoneFlow`:
- `test_no_habits_configured_shows_error` - Verifies ERROR_NO_HABITS shown when user has zero habits (bug fix verification)
- `test_all_habits_completed_shows_success` - Verifies INFO_ALL_HABITS_COMPLETED shown when all habits done today
- `test_pending_habits_shows_simple_keyboard` - Verifies simple keyboard shown for pending habits
- `test_user_not_found_shows_error` - Verifies error handling for missing users

All tests parameterized for 3 languages (en, ru, kk) = 12 tests total, all passing ‚úÖ
