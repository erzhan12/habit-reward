# Feature 0002: Django-Compatible Multi-lingual Message Management System

## Overview

Implement a centralized message management system that:
- Consolidates all user-facing strings from across the codebase (currently scattered across 15+ files)
- Supports multi-lingual architecture using dictionary-based approach (Phase 1)
- Provides clean migration path to Django's i18n framework with GNU gettext (Phase 2)
- Adds language preference field to User model
- Implements language detection from Telegram user settings
- Follows Django-compatible patterns as specified in RULES.md

**Current State**: 57 message strings are hardcoded across handlers, formatters, and service files.

**Goal**: Centralize all messages in `src/bot/messages.py` with multi-lingual support and Django migration readiness.

---

## Phase 1: Data Layer - Models & Configuration

### 1.1 Update User Model

**File**: `src/models/user.py`

Add language preference field:
- Field name: `language`
- Type: `str`
- Default: `'en'`
- Description: "User's preferred language (ISO 639-1 code)"
- Validator: Ensure language code is 2-letter lowercase (en, ru, kk, etc.)

### 1.2 Update Configuration

**File**: `src/config.py`

Add i18n settings to `Settings` class:
- `supported_languages`: list of supported language codes (default: `['en', 'ru', 'kk']`)
- `default_language`: default language code (default: `'en'`)

### 1.3 Update Airtable Schema

**File**: Documentation update in appropriate location

User table in Airtable needs new field:
- Field name: `Language`
- Type: Single line text
- Default value: `en`

### 1.4 Update User Repository

**File**: `src/airtable/user_repository.py` or `src/airtable/repositories.py`

Ensure `language` field is:
- Mapped correctly from Airtable to User model
- Included in create/update operations
- Has proper default handling

---

## Phase 2: Message Management Module

### 2.1 Create Messages Module

**File**: `src/bot/messages.py` (NEW)

Create centralized message constants module with:

**Structure**:
```
class Messages:
    # Error Messages (10+ strings)
    ERROR_USER_NOT_FOUND
    ERROR_USER_INACTIVE
    ERROR_NO_HABITS
    ERROR_HABIT_NOT_FOUND
    ERROR_REWARD_NOT_FOUND
    ERROR_INVALID_STATUS
    ERROR_CANNOT_CLAIM

    # Success Messages (5+ strings)
    SUCCESS_HABIT_COMPLETED
    SUCCESS_REWARD_CLAIMED
    SUCCESS_STATUS_UPDATED

    # Info Messages (8+ strings)
    INFO_NO_REWARD
    INFO_NO_PROGRESS
    INFO_REWARD_ACTIONABLE
    INFO_FEATURE_COMING_SOON

    # Help & Instructions (10+ strings)
    HELP_CLAIM_REWARD_USAGE
    HELP_SET_STATUS_USAGE
    HELP_HABIT_SELECTION
    HELP_CUSTOM_TEXT

    # Translations dictionary
    _TRANSLATIONS = {
        'ru': {...},
        'kk': {...}
    }

    # Methods
    @classmethod
    get(cls, key: str, lang: str = 'en', **kwargs) -> str
```

**Translation dictionary structure**:
- Support English (default), Russian, Kazakh initially
- Each language is a dict mapping constant name to translated string
- Support string formatting with `{variable}` placeholders

**Helper function**:
```
def msg(key: str, lang: str = 'en', **kwargs) -> str
```

**Extract all messages from**:
- `src/bot/main.py`: 6 hardcoded messages
- `src/bot/handlers/reward_handlers.py`: 8 hardcoded messages
- `src/bot/handlers/habit_done_handler.py`: 3 hardcoded messages
- `src/bot/handlers/streak_handler.py`: 2 hardcoded messages
- `src/bot/formatters.py`: 8 messages in format functions
- Update RULES.md references to use constant names

### 2.2 Create Language Context Manager

**File**: `src/bot/language.py` (NEW)

Helper utilities for language handling:

**Functions**:
- `get_user_language(telegram_id: str) -> str`: Fetch user's language preference from repository
- `detect_language_from_telegram(update: Update) -> str`: Extract language code from Telegram user object
- `set_user_language(telegram_id: str, language_code: str) -> None`: Update user's language preference

**Integration with Telegram**:
- Use `update.effective_user.language_code` for detection
- Fallback chain: User DB preference ‚Üí Telegram preference ‚Üí config default

---

## Phase 3A: Update Bot Handlers

### 3.1 Update Main Bot Handlers

**File**: `src/bot/main.py`

Replace 6 hardcoded messages:
- Line 33-34: `ERROR_USER_NOT_FOUND`
- Line 40-41: `ERROR_USER_INACTIVE`
- Lines 44-56: `HELP_START_MESSAGE` (multi-line welcome)
- Lines 78-95: `HELP_COMMAND_MESSAGE` (multi-line help)

Pattern for each handler:
1. Get user language: `lang = get_user_language(telegram_id)`
2. Replace `reply_text("hardcoded string")` with `reply_text(msg('CONSTANT_NAME', lang))`
3. For formatted strings: `msg('CONSTANT_NAME', lang, variable=value)`

### 3.2 Update Reward Handlers

**File**: `src/bot/handlers/reward_handlers.py`

Replace 8 hardcoded messages in functions:
- `my_rewards_command`: Lines 30-31, 36-37, 45 (3 messages)
- `claim_reward_command`: Lines 68-71, 79-80, 86-87, 94, 101-105 (6 messages)
- `set_reward_status_command`: Lines 117-121, 135-136, 145-146, 152-153, 160, 171-174 (8 messages)
- `add_reward_command`: Lines 183-189 (1 message)

Add language detection at start of each handler function.

### 3.3 Update Habit Done Handler

**File**: `src/bot/handlers/habit_done_handler.py`

Replace 3 hardcoded messages:
- Line 35-36: `ERROR_USER_NOT_FOUND`
- Line 41-43: `ERROR_USER_INACTIVE`
- Line 51-52: `ERROR_NO_HABITS`
- Lines 58-60: `HELP_HABIT_SELECTION`
- Line 82: `HELP_CUSTOM_TEXT`
- Line 95: `ERROR_HABIT_NOT_FOUND`
- Lines 135-138: `INFO_NO_MATCH_HABIT`
- Lines 159-161: `INFO_MULTIPLE_HABITS`
- Line 172: `INFO_CANCELLED`

### 3.4 Update Streak Handler

**File**: `src/bot/handlers/streak_handler.py`

Replace 2 hardcoded messages:
- Line 21-22: `ERROR_USER_NOT_FOUND`
- Line 27-28: `ERROR_USER_INACTIVE`
- Line 36-38: `INFO_NO_STREAKS`

---

## Phase 3B: Update Formatters

### 3.5 Update Message Formatters

**File**: `src/bot/formatters.py`

Refactor formatting functions to accept `language` parameter:

**Functions to update**:
1. `format_habit_completion_message(result, language='en')`: Update 8 embedded strings
   - Line 23: "Habit completed"
   - Line 27: "Streak"
   - Line 32: "Reward"
   - Line 39: "Progress"
   - Line 43: "Reward achieved!"
   - Line 47: "No reward this time"
   - Line 51: Motivational quote prefix

2. `format_reward_progress_message(progress, reward, language='en')`: Update 2 strings
   - Line 75: "Status"
   - Line 79: "Ready to claim!"

3. `format_streaks_message(streaks, language='en')`: Update 2 strings
   - Line 95: "No habits logged yet"
   - Line 97: "Your Current Streaks"

4. `format_rewards_list_message(rewards, language='en')`: Update 2 strings
   - Line 124: "No rewards configured yet"
   - Line 126: "Available Rewards"

5. `format_habit_logs_message(logs, habits, language='en')`: Update 2 strings
   - Line 158: "No habit logs found"
   - Line 160: "Recent Habit Completions"

**Pattern**:
- Add `language='en'` parameter to each function signature
- Import `from src.bot.messages import msg`
- Replace hardcoded strings with `msg('CONSTANT_NAME', language)`
- Update all call sites in handlers to pass language parameter

---

## Phase 4: Language Detection & Initialization

### 4.1 Create Onboarding Logic

**File**: `src/bot/main.py`

Update `start_command` function:
1. Check if user exists
2. If new user (doesn't exist):
   - Detect language from `update.effective_user.language_code`
   - Create user with detected language
3. If existing user without language preference:
   - Detect and update language field
4. Welcome message uses user's language

### 4.2 Add Language Change Command (Optional)

**File**: `src/bot/handlers/settings_handler.py` (NEW, optional)

Create `/language` command:
- Shows current language
- Provides inline keyboard to select from supported languages
- Updates user language preference
- Confirms in new language

---

## Phase 5: Testing & Migration Preparation

### 5.1 Update Tests

**Files**: `tests/test_bot_handlers.py`, others as needed

Update test expectations:
- Import message constants from `src.bot.messages`
- Assert against constants instead of hardcoded strings
- Add tests for multi-lingual behavior
- Test language detection logic
- Test fallback to default language

### 5.2 Create Migration Documentation

**File**: `docs/DJANGO_MIGRATION.md` (NEW)

Document migration path from Phase 1 (dictionary-based) to Phase 2 (Django gettext):

**Steps**:
1. How to wrap constants with `gettext_lazy()`
2. How to run `django-admin makemessages`
3. How to migrate dictionary translations to `.po` files
4. How to compile messages
5. Middleware configuration

### 5.3 Update RULES.md

**File**: `RULES.md`

Add section on message management:
- Always use `Messages` constants (never hardcoded strings)
- How to add new messages
- How to add new languages
- Reference to message constants in error message patterns section

---

## Specific Message Extraction

### Messages by Category

**Error Messages (User Validation)**:
- "‚ùå User not found. Please contact admin to register." (appears 4 times)
- "‚ùå Your account is not active. Please contact admin." (appears 4 times)

**Error Messages (Entity Not Found)**:
- "No active habits found. Please add habits first."
- "No habits logged yet. Use /habit_done to start building your streaks!"
- "Habit not found. Please try again."
- "Reward '{reward_name}' not found." (format string)
- "I couldn't match your text to any known habit."

**Error Messages (Validation)**:
- "Invalid status. Use: pending, achieved, or completed"
- "Error: {str(e)}" (format string)

**Info Messages**:
- "No reward progress yet. Keep completing habits!"
- "‚ùå No reward this time - keep going!"
- "‚è≥ *Reward achieved!* You can claim it now!"
- "Habit logging cancelled."
- "This feature will guide you through creating a new reward."

**Usage/Help Messages**:
- "Usage: /claim_reward <reward_name>\nExample: /claim_reward Coffee at favorite cafe"
- "Usage: /set_reward_status <reward_name> <status>\nStatus options: pending, achieved, completed\nExample: /set_reward_status Coffee pending"
- "Which habit did you complete? üéØ\n\nSelect from the list below:"
- "Please type what habit you completed:"

**Success Messages**:
- "‚úÖ Reward claimed: *{reward.name}*\nStatus: {updated_progress.status.value}\n\nCongratulations! üéâ"
- "‚úÖ Reward status updated: *{reward.name}*\nNew status: {updated_progress.status.value}"
- "‚úÖ *Habit completed:* {habit_name}"

**Headers/Titles**:
- "üéÅ *Your Reward Progress:*\n"
- "üî• *Your Current Streaks:*\n"
- "üéÅ *Available Rewards:*\n"
- "üìã *Recent Habit Completions:*\n"
- "üéÅ *Add New Reward*\n\n"
- "üéØ *Welcome to Habit Reward System!*\n\n"
- "üéØ <b>Habit Reward System Help</b>\n\n"

---

## Algorithm: Language Resolution

```
Function get_message_for_user(telegram_id, message_key, format_args):
    1. Try to fetch user from repository by telegram_id
    2. If user exists and has language field:
        language = user.language
    3. Else if Telegram update available:
        language = update.effective_user.language_code
    4. Else:
        language = config.default_language

    5. Normalize language code (lowercase, first 2 chars)
    6. If language not in supported_languages:
        language = config.default_language

    7. Return msg(message_key, language, **format_args)
```

---

## Files to Create

1. `src/bot/messages.py` - Message constants and translation management
2. `src/bot/language.py` - Language detection and context utilities
3. `docs/DJANGO_MIGRATION.md` - Migration guide to Django gettext
4. `src/bot/handlers/settings_handler.py` - (Optional) Language settings command

---

## Files to Modify

1. `src/models/user.py` - Add language field
2. `src/config.py` - Add i18n settings
3. `src/airtable/user_repository.py` - Handle language field
4. `src/bot/main.py` - Replace 6 messages, add language detection
5. `src/bot/handlers/reward_handlers.py` - Replace 8+ messages
6. `src/bot/handlers/habit_done_handler.py` - Replace 3+ messages
7. `src/bot/handlers/streak_handler.py` - Replace 2+ messages
8. `src/bot/formatters.py` - Add language parameter to 5 functions
9. `RULES.md` - Add message management guidelines
10. `tests/test_bot_handlers.py` - Update test assertions

---

## Django Migration Path (Future)

When migrating to Django:

1. Wrap all `Messages` class attributes with `gettext_lazy()`:
   ```python
   from django.utils.translation import gettext_lazy as _
   ERROR_USER_NOT_FOUND = _("User not found. Please contact admin to register.")
   ```

2. Remove `_TRANSLATIONS` dictionary

3. Run message extraction:
   ```bash
   django-admin makemessages -l ru -l kk
   ```

4. Copy translations from dictionary to `.po` files

5. Compile messages:
   ```bash
   django-admin compilemessages
   ```

6. Enable `LocaleMiddleware` in Django settings

7. Remove `get()` method and `msg()` helper (use `_()` directly)

---

## Dependencies

- No new external dependencies required for Phase 1
- Django migration (Phase 2) requires: `django>=4.2` (future)

---

## Success Criteria

- All 57+ hardcoded strings extracted to `messages.py`
- User model includes language preference
- Language auto-detected from Telegram on first interaction
- All messages support at least 3 languages (en, ru, kk)
- All tests pass with updated assertions
- Zero breaking changes to existing functionality
- Clean migration path to Django documented
