# Feature 0032: Add Confirmation Message for "Yesterday" Habit Completion

## Description

When a user marks a habit as done for "yesterday", the completion is processed immediately with no confirmation step. The "for date" (select date) flow already shows a confirmation message ("Log **habit** for **date**?") with Yes/No buttons before processing. This creates an inconsistent UX and can lead to accidental logging.

**Goal**: Add the same confirmation step used by "for date" to the "yesterday" flow. Only past-date completions need confirmation — today does not.

## Current Behavior

### "Yesterday" flow (no confirmation):
```
SELECTING_DATE_OPTION → handle_yesterday_selection() → process immediately → END
```
- `handle_yesterday_selection()` at `src/bot/handlers/habit_done_handler.py:338`
- Calls `habit_service.process_habit_completion()` directly (line 368)
- Returns `ConversationHandler.END` immediately

### "For Date" flow (has confirmation):
```
SELECTING_DATE_OPTION → handle_select_date() → SELECTING_BACKDATE_DATE
  → handle_backdate_date_selection() → CONFIRMING_BACKDATE
  → handle_backdate_confirmation() → process → END
```
- Confirmation shown at `handle_backdate_date_selection()` line 561-566
- Uses `HELP_BACKDATE_CONFIRM` message: `"Log <b>{habit_name}</b> for <b>{date}</b>?"`
- Uses `build_backdate_confirmation_keyboard()` from `src/bot/keyboards.py:1233`
- Callback pattern: `backdate_confirm_{habit_id}_{date_iso}`

## Changes Required

### File: `src/bot/handlers/habit_done_handler.py`

#### 1. Modify `handle_yesterday_selection()` (line 338)

Instead of calling `habit_service.process_habit_completion()` directly, this function should:

1. Calculate yesterday's date (already done at line 363)
2. Get `habit_id` from `context.user_data` (already available)
3. Store `context.user_data['backdate_date'] = yesterday`
4. Show the confirmation message using `HELP_BACKDATE_CONFIRM` with `habit_name` and formatted yesterday date
5. Show the confirmation keyboard using `build_backdate_confirmation_keyboard(habit_id, yesterday, lang)`
6. Return `CONFIRMING_BACKDATE` instead of `ConversationHandler.END`

**Algorithm:**
- Remove the entire `try/except` block that processes the habit (lines 366-409)
- Remove the context cleanup at lines 411-413 (this will happen in `handle_backdate_confirmation` instead)
- Replace with: format yesterday date, show confirmation message + keyboard, return `CONFIRMING_BACKDATE`

#### 2. No changes needed to `handle_backdate_confirmation()` (line 573)

The existing confirmation handler already:
- Reads `habit_id` and `date_iso` from callback data (`backdate_confirm_{habit_id}_{date_iso}`)
- Calls `habit_service.process_habit_completion()` with the parsed date
- Handles all error cases
- Cleans up context

Since `build_backdate_confirmation_keyboard` encodes `habit_id` and `target_date` in the callback data, the existing confirmation handler will work for yesterday's date without modification.

#### 3. No changes to ConversationHandler states (line 677)

The existing state machine already supports this flow:
- `SELECTING_DATE_OPTION` already routes `^habit_.*_yesterday$` to `handle_yesterday_selection()`
- `CONFIRMING_BACKDATE` already handles `^backdate_confirm_` and `^backdate_cancel$`
- The `handle_yesterday_selection()` just needs to return `CONFIRMING_BACKDATE` to transition into the existing confirmation state

### File: `src/bot/messages.py`

No changes needed. The existing `HELP_BACKDATE_CONFIRM` message already works for any date:
- EN: `"Log <b>{habit_name}</b> for <b>{date}</b>?"`
- RU: `"Записать <b>{habit_name}</b> на <b>{date}</b>?"`
- KZ: `"<b>{habit_name}</b> әдетін <b>{date}</b> күніне жазу керек пе?"`

### File: `src/bot/keyboards.py`

No changes needed. `build_backdate_confirmation_keyboard()` (line 1233) already accepts any `target_date` and encodes it into callback data.

## Summary of Changes

| File | Function | Change |
|------|----------|--------|
| `habit_done_handler.py` | `handle_yesterday_selection()` | Replace direct processing with confirmation prompt, return `CONFIRMING_BACKDATE` |

This is a minimal change — the entire confirmation infrastructure already exists. The "yesterday" handler just needs to use it instead of bypassing it.

## Unit Tests

### Test file: `tests/test_habit_done_handler.py` (or equivalent existing test file)

#### Test scenarios:

1. **Yesterday selection shows confirmation message**
   - Simulate clicking "Yesterday" button
   - Assert the response message contains `HELP_BACKDATE_CONFIRM` text with habit name and yesterday's date
   - Assert the response includes the confirmation keyboard (Yes/No buttons)
   - Assert the handler returns `CONFIRMING_BACKDATE` state

2. **Yesterday confirmation processes the habit**
   - Simulate clicking "Yesterday" → then clicking "Yes" on confirmation
   - Assert `habit_service.process_habit_completion()` is called with `target_date=yesterday`
   - Assert success message is shown with `SUCCESS_BACKDATE_COMPLETED`

3. **Yesterday cancellation does not process the habit**
   - Simulate clicking "Yesterday" → then clicking "No" on confirmation
   - Assert `habit_service.process_habit_completion()` is NOT called
   - Assert conversation ends cleanly

4. **Yesterday confirmation with already-completed habit**
   - Simulate clicking "Yesterday" → "Yes" when habit is already logged for yesterday
   - Assert `ERROR_BACKDATE_DUPLICATE` error message is shown

5. **Context data is preserved through confirmation flow**
   - Assert `context.user_data['backdate_date']` is set to yesterday after selection
   - Assert context is cleaned up after confirmation or cancellation
