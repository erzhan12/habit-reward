# Feature 0015: Comprehensive Bot Audit Log System

## Description

Create a comprehensive audit trail table to log all high-level Telegram bot interactions for debugging data corruption issues (like orphaned RewardProgress entries with 0 pieces) and user support. The system will capture event snapshots including reward progress state, retain logs for 90 days with automatic cleanup, and provide helper methods to trace event timelines for specific users and rewards.

## Requirements

- **Detail Level**: High-level events only (commands executed, habit completions, reward selections/claims, button clicks that modify database records, errors)
- **Retention**: 90 days with automatic cleanup
- **State Snapshots**: Capture reward progress values, streak counts, selected reward details as JSON
- **Use Cases**: Debug data corruption scenarios, support users with activity history

## Phase 1: Data Layer

### 1.1 Django Model - BotAuditLog

**File**: `src/core/models.py`

Add new model `BotAuditLog` with fields:
- `timestamp` (DateTimeField, auto_now_add, indexed)
- `user` (ForeignKey to User, CASCADE, indexed)
- `event_type` (CharField with TextChoices: COMMAND, HABIT_COMPLETED, REWARD_SELECTED, REWARD_CLAIMED, REWARD_REVERTED, BUTTON_CLICK, ERROR)
- `command` (CharField, nullable) - e.g., "/habit_done", "/streaks"
- `callback_data` (CharField, nullable) - Button callback data
- `habit` (ForeignKey to Habit, SET_NULL, nullable)
- `reward` (ForeignKey to Reward, SET_NULL, nullable)
- `habit_log` (ForeignKey to HabitLog, SET_NULL, nullable)
- `snapshot` (JSONField, nullable) - State at time of event
- `error_message` (TextField, nullable)

**Indexes**:
- Composite: `(user, -timestamp)`
- Composite: `(event_type, -timestamp)`

**Meta**: Default ordering by `-timestamp`

### 1.2 Database Migration

**File**: `src/core/migrations/0003_add_bot_audit_log.py`

Create migration for BotAuditLog model with indexes.

## Phase 2: Service Layer

### 2.1 AuditLogService

**File**: `src/services/audit_log_service.py` (NEW)

Create service class with methods:

**`log_command(user_id, command, snapshot=None)`**
- Create BotAuditLog entry with event_type=COMMAND
- Store command name and optional snapshot

**`log_habit_completion(user_id, habit, reward, habit_log, snapshot)`**
- Create entry with event_type=HABIT_COMPLETED
- Link habit, reward (if awarded), habit_log
- Store snapshot containing:
  - `reward_progress` dict: pieces_earned, pieces_required, claimed
  - `streak_count`
  - `total_weight`
  - `selected_reward_name`

**`log_reward_claim(user_id, reward, progress_snapshot)`**
- Create entry with event_type=REWARD_CLAIMED
- Store snapshot with pieces_earned before/after claim

**`log_error(user_id, error_message, context)`**
- Create entry with event_type=ERROR
- Store error message and context snapshot

**`log_button_click(user_id, callback_data, snapshot=None)`**
- Create entry with event_type=BUTTON_CLICK
- Store callback_data from inline keyboard buttons (only when the action results in a DB mutation)

**`get_user_timeline(user_id, hours=24)`**
- Query BotAuditLog filtered by user and timestamp range
- Return chronological list of events with snapshots

**`trace_reward_corruption(user_id, reward_id)`**
- Query all logs for specific user + reward combination
- Reconstruct timeline to identify data corruption points
- Return list of events with snapshots showing state changes

**`cleanup_old_logs(days=90)`**
- Delete BotAuditLog entries older than retention period
- Return count of deleted records

**Global instance**: `audit_log_service = AuditLogService()`

## Phase 3: Integration Points

### 3.1 Habit Service Integration

**File**: `src/services/habit_service.py`

**Function**: `process_habit_completion()` at line ~212 (after transaction commits)

Add call to `audit_log_service.log_habit_completion()` with:
- user_id, habit, selected_reward, created habit_log
- snapshot containing reward_progress state, streak_count, total_weight

### 3.2 Reward Handlers Integration

**File**: `src/bot/handlers/reward_handlers.py`

**Function**: `claim_reward_command()` (after successful claim)

Add call to `audit_log_service.log_reward_claim()` with:
- user_id, reward
- progress_snapshot showing pieces_earned before (should equal pieces_required) and after (0)

**Function**: Error handlers throughout file

Wrap try-except blocks to call `audit_log_service.log_error()` on exceptions.

### 3.3 Main Bot Handlers

**File**: `src/bot/main.py`

**Functions**: `start_command()`, `help_command()` and other command handlers

Add `audit_log_service.log_command()` calls at start of each handler.

### 3.4 Habit Management Handlers

**File**: `src/bot/handlers/habit_management_handler.py`

**Callback handlers**: Button clicks during habit add/edit/remove flows that persist changes

Add `audit_log_service.log_button_click()` calls only for callbacks that create/update/delete records (e.g., confirming habit creation, saving edits, confirming removal).

## Phase 4: Admin & Maintenance

### 4.1 Django Admin Interface

**File**: `src/core/admin.py`

Register `BotAuditLog` with `BotAuditLogAdmin`:
- list_display: timestamp, user, event_type, command, habit, reward
- list_filter: event_type, timestamp
- search_fields: user__telegram_id, command, error_message
- readonly_fields: timestamp, snapshot
- date_hierarchy: timestamp
- Disable add permission (read-only logs)

### 4.2 Cleanup Management Command

**File**: `src/core/management/commands/cleanup_audit_logs.py` (NEW)

Django management command that:
- Calculates cutoff date (90 days ago from now)
- Deletes BotAuditLog entries with timestamp < cutoff_date
- Outputs count of deleted records
- Intended to run daily via cron: `0 2 * * * python manage.py cleanup_audit_logs`

## Phase 5: Documentation

### 5.1 RULES.md Updates

**File**: `RULES.md`

Add section documenting:
- When to use audit logging (all high-level bot interactions)
- How to query logs for debugging (using trace_reward_corruption, get_user_timeline)
- Snapshot structure for different event types
- Retention policy and cleanup schedule

## Files Summary

**New Files**:
- `src/services/audit_log_service.py`
- `src/core/migrations/0003_add_bot_audit_log.py`
- `src/core/management/commands/cleanup_audit_logs.py`

**Modified Files**:
- `src/core/models.py` - Add BotAuditLog model
- `src/core/admin.py` - Add admin interface
- `src/services/habit_service.py` - Log habit completions
- `src/bot/handlers/reward_handlers.py` - Log reward claims and errors
- `src/bot/main.py` - Log command executions
- `src/bot/handlers/habit_management_handler.py` - Log only button callbacks that modify stored data
- `RULES.md` - Document audit log patterns
