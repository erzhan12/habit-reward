# Feature 0004: Interactive Reward Claiming with Inline Keyboard

## Description

Transform the `/claim_reward` command from a text-based input (where users type the reward name) to an interactive inline keyboard flow. When users execute `/claim_reward`, they will see a list of all achieved rewards (status='‚è≥ Achieved') displayed as clickable buttons. Users select the reward they want to claim from the keyboard, and the system marks it as completed.

## Files to Modify

### 1. `src/bot/handlers/reward_handlers.py`

**Current function:** `claim_reward_command()` (lines 88-155)
- **Change from:** Command handler expecting `context.args` with reward name
- **Change to:** Entry point for a ConversationHandler that shows inline keyboard
- **Algorithm:**
  1. Validate user exists and is active (keep existing validation)
  2. Call `reward_service.get_actionable_rewards(user.id)` to fetch achieved rewards
  3. If no achieved rewards: send informative message `msg('INFO_NO_REWARDS_TO_CLAIM', lang)` and end
  4. If achieved rewards exist:
     - Build inline keyboard using `build_claimable_rewards_keyboard(progress_list, reward_list, lang)`
     - Send keyboard with header message `msg('HELP_SELECT_REWARD_TO_CLAIM', lang)`
     - Return conversation state `AWAITING_REWARD_SELECTION`

**New function:** `claim_reward_callback()` (callback query handler)
- Handles callback data matching pattern `^claim_reward_`
- **Algorithm:**
  1. Extract `reward_id` from callback data (format: `claim_reward_<reward_id>`)
  2. Validate user exists and is active
  3. Call `reward_service.mark_reward_completed(user.id, reward_id)`
  4. Fetch updated reward progress: `reward_service.get_user_reward_progress(user.id)`
  5. Format success message with updated progress using new formatter
  6. Edit message to show success + updated progress summary
  7. End conversation
  8. Handle errors (ValueError) with error message

**New ConversationHandler:** `claim_reward_conversation`
- Entry point: `CommandHandler("claim_reward", claim_reward_command)`
- State `AWAITING_REWARD_SELECTION`: CallbackQueryHandler with pattern `^claim_reward_`
- Fallbacks: `CommandHandler("cancel", cancel_handler)` (reuse from habit_done_handler)

### 2. `src/bot/keyboards.py`

**Update function:** `build_actionable_rewards_keyboard()` (lines 61-83)
- **Current:** Takes `list[RewardProgress]`, shows only progress pieces format
- **Change to:** `build_claimable_rewards_keyboard(progress_list: list[RewardProgress], rewards_dict: dict[str, Reward], language: str)`
- **New parameters:**
  - `progress_list`: List of achieved RewardProgress objects
  - `rewards_dict`: Dictionary mapping reward_id to Reward object (for name lookup)
  - `language`: Language code for formatting
- **Algorithm:**
  1. If no progress_list, return None
  2. For each progress in progress_list:
     - Lookup reward from rewards_dict
     - Format button text: `"{reward.name} ({progress.pieces_earned}/{progress.pieces_required})"`
     - Create InlineKeyboardButton with callback_data: `f"claim_reward_{progress.reward_id}"`
  3. Return InlineKeyboardMarkup with buttons

### 3. `src/bot/formatters.py`

**New function:** `format_claim_success_with_progress(reward_name: str, progress_list: list[RewardProgress], rewards_dict: dict[str, Reward], language: str) -> str`
- **Purpose:** Format success message after claiming reward, including updated reward progress summary
- **Algorithm:**
  1. Start with success header: `msg('SUCCESS_REWARD_CLAIMED_HEADER', lang, reward_name=reward_name)`
  2. Add separator line
  3. Append updated progress header: `msg('HEADER_UPDATED_REWARD_PROGRESS', lang)`
  4. For each progress in progress_list:
     - Get reward from rewards_dict
     - Format using existing `format_reward_progress_message(progress, reward, language)`
     - Append with separator
  5. Return joined message

### 4. `src/bot/messages.py`

**New message constants to add:**

```python
# Info messages
INFO_NO_REWARDS_TO_CLAIM = "You have no rewards ready to claim yet. Keep logging habits to earn rewards!"

# Help/instruction messages
HELP_SELECT_REWARD_TO_CLAIM = "üéÅ <b>Select a reward to claim:</b>"

# Success messages
SUCCESS_REWARD_CLAIMED_HEADER = "‚úÖ <b>Reward claimed:</b> {reward_name}"

# Headers
HEADER_UPDATED_REWARD_PROGRESS = "\nüìä <b>Your updated reward progress:</b>"
```

**Translations to add for ru and kk:**
- Translate all new constants to Russian and Kazakh
- Follow existing pattern in `_TRANSLATIONS` dictionary

### 5. `src/bot/main.py`

**Changes:**
- Line 10-15: Import the new conversation handler `claim_reward_conversation` instead of `claim_reward_command`
- Line 124: Replace `CommandHandler("claim_reward", claim_reward_command)` with `application.add_handler(claim_reward_conversation)`

## Helper Functions Needed

### In `src/bot/handlers/reward_handlers.py`

**Helper function:** `_get_rewards_dict(progress_list: list[RewardProgress]) -> dict[str, Reward]`
- **Purpose:** Fetch reward objects for all rewards in progress list
- **Algorithm:**
  1. Extract unique reward_ids from progress_list
  2. For each reward_id, call `reward_repository.get_by_id(reward_id)`
  3. Return dict mapping reward_id ‚Üí Reward object

## Data Flow

**User initiates claim:**
1. User sends `/claim_reward`
2. System fetches achieved rewards via `reward_service.get_actionable_rewards(user_id)`
3. System displays inline keyboard with claimable rewards

**User claims reward:**
1. User clicks reward button (callback: `claim_reward_<reward_id>`)
2. System calls `reward_service.mark_reward_completed(user_id, reward_id)`
3. System fetches updated progress via `reward_service.get_user_reward_progress(user_id)`
4. System displays success message with updated progress summary
5. Conversation ends

## Edge Cases

1. **No achieved rewards:** Show `INFO_NO_REWARDS_TO_CLAIM` message, end conversation
2. **Reward already claimed between showing keyboard and claiming:** Catch ValueError from `mark_reward_completed()`, show error message
3. **User becomes inactive during conversation:** Validate user status in callback handler
4. **Reward not in 'Achieved' status:** `mark_reward_completed()` already validates this, throws ValueError

## Testing Considerations

1. Test with no achieved rewards
2. Test with single achieved reward
3. Test with multiple achieved rewards
4. Test claiming reward successfully
5. Test error when reward not in achieved status
6. Test conversation cancellation via `/cancel`
7. Test with different languages (en, ru, kk)

## Backward Compatibility

**Breaking change:** Users can no longer use `/claim_reward Coffee` syntax. The command now requires interactive selection.

**Migration:** Update help message and documentation to reflect new interactive flow.
