# Feature 0020: Backdate Habit Completion

## Description

Allow users to complete habits for past dates (up to 7 days back) through the Telegram bot. This addresses the common scenario where users forget to log completions or couldn't access the bot on the completion day. The feature includes a "Log for Yesterday" quick button alongside the regular habit completion flow, plus an option to select a specific past date.

## Key Requirements

- **Backdate limit**: Up to 7 days in the past
- **Duplicate prevention**: Cannot log the same habit twice for the same date
- **Validation**: Cannot backdate before the habit was created
- **Streak recalculation**: Backdated entries correctly affect streak calculations
- **User timezone awareness**: "Yesterday" respects user's timezone (Phase 2 consideration; use server timezone for now)
- **Confirmation dialog**: Show selected date before logging
- **Calendar view**: Display which dates already have completions for the selected habit

## Phase 1: Data Layer

### 1.1 Repository Layer Enhancement

**File**: `src/core/repositories.py`

**HabitLogRepository** - Add method to check for existing completions on a specific date:

```python
async def get_log_for_habit_on_date(
    self,
    user_id: int | str,
    habit_id: int | str,
    target_date: date
) -> HabitLog | None:
    """Check if a habit was already completed on a specific date."""
```

**Algorithm**:
1. Filter by `user_id`, `habit_id`, and `last_completed_date=target_date`
2. Return first match or None

### 1.2 Model Updates (No Changes Required)

The existing `HabitLog` model already has `last_completed_date: DateField` which stores the completion date independently from `timestamp`. The `timestamp` field (auto_now_add) records when the log was created, while `last_completed_date` is used for streak tracking and can be set to a past date.

## Phase 2: Service Layer

### 2.1 HabitService Extension

**File**: `src/services/habit_service.py`

**Modify `process_habit_completion()` signature** (line ~105):

```python
def process_habit_completion(
    self,
    user_telegram_id: str,
    habit_name: str,
    target_date: date | None = None  # NEW: Optional backdate
) -> HabitCompletionResult | Awaitable[HabitCompletionResult]:
```

**Algorithm changes** in `_impl()` (lines ~138-244):

1. **Default target_date** (after user validation, ~line 155):
   ```python
   if target_date is None:
       target_date = date.today()
   ```

2. **Validate target_date** (new validation block, ~line 160):
   ```python
   today = date.today()
   max_backdate_days = 7
   earliest_allowed = today - timedelta(days=max_backdate_days)
   
   if target_date > today:
       raise ValueError("Cannot log habits for future dates")
   if target_date < earliest_allowed:
       raise ValueError(f"Cannot backdate more than {max_backdate_days} days")
   if target_date < habit.created_at.date():
       raise ValueError("Cannot backdate before habit was created")
   ```

3. **Check for duplicate entries** (new check, ~line 175):
   ```python
   existing_log = await maybe_await(
       self.habit_log_repo.get_log_for_habit_on_date(user.id, habit.id, target_date)
   )
   if existing_log:
       raise ValueError(f"Habit '{habit_name}' already completed on {target_date}")
   ```

4. **Calculate streak for target_date** (modify ~line 162):
   ```python
   streak_count = await maybe_await(
       self.streak_service.calculate_streak_for_date(user.id, habit.id, target_date)
   )
   ```

5. **Update HabitLog creation** (modify ~line 196-206):
   ```python
   habit_log = HabitLog(
       user_id=user.id,
       habit_id=habit.id,
       timestamp=datetime.now(),  # When logged (unchanged)
       reward_id=selected_reward.id if got_reward else None,
       got_reward=got_reward,
       streak_count=streak_count,
       habit_weight=habit_weight,
       total_weight_applied=total_weight,
       last_completed_date=target_date,  # Use target_date instead of date.today()
   )
   ```

### 2.2 StreakService Extension

**File**: `src/services/streak_service.py`

**Add new method `calculate_streak_for_date()`** (after `calculate_streak()`, ~line 77):

```python
def calculate_streak_for_date(
    self,
    user_id: str,
    habit_id: str,
    target_date: date
) -> int | Awaitable[int]:
    """Calculate streak for a specific target date (for backdated completions)."""
```

**Algorithm**:
1. Find the most recent log BEFORE `target_date` for this habit
2. Check if `target_date - 1` (the day before target) has a completion:
   - If yes: `previous_log.streak_count + 1`
   - If no: Apply grace days and exempt weekdays logic (same as `calculate_streak()`)
3. Handle edge case: if target_date is in the middle of an existing streak, don't double-count

**Implementation detail**: Query `HabitLog.objects.filter(user_id=X, habit_id=Y, last_completed_date__lt=target_date).order_by('-last_completed_date').first()`

### 2.3 New Service Method for Getting Completion Calendar

**File**: `src/services/habit_service.py`

**Add method `get_habit_completions_for_daterange()`**:

```python
def get_habit_completions_for_daterange(
    self,
    user_id: int | str,
    habit_id: int | str,
    start_date: date,
    end_date: date
) -> list[date] | Awaitable[list[date]]:
    """Get all dates with completions for a habit within a date range."""
```

Used to show which dates already have completions when presenting the date picker.

## Phase 3: Bot Handler Layer

### 3.1 New Handler: Backdate Habit Completion

**File**: `src/bot/handlers/backdate_handler.py` (NEW)

**Conversation states**:
```python
SELECTING_HABIT = 1
SELECTING_DATE = 2
CONFIRMING_COMPLETION = 3
```

**Entry point**: Command `/backdate` or callback from main habit_done flow

**Handler functions**:

1. **`backdate_command()`** - Entry point, shows habit selection keyboard
2. **`habit_selected_for_backdate()`** - After habit selection, shows date picker
3. **`date_selected_for_backdate()`** - After date selection, shows confirmation
4. **`confirm_backdate_completion()`** - Executes the backdated completion
5. **`cancel_backdate()`** - Cancels the flow

**ConversationHandler**:
```python
backdate_conversation = ConversationHandler(
    entry_points=[
        CommandHandler("backdate", backdate_command),
        CallbackQueryHandler(backdate_command, pattern="^backdate_start$")
    ],
    states={
        SELECTING_HABIT: [
            CallbackQueryHandler(habit_selected_for_backdate, pattern="^backdate_habit_")
        ],
        SELECTING_DATE: [
            CallbackQueryHandler(date_selected_for_backdate, pattern="^backdate_date_"),
            CallbackQueryHandler(show_calendar_week, pattern="^backdate_week_")
        ],
        CONFIRMING_COMPLETION: [
            CallbackQueryHandler(confirm_backdate_completion, pattern="^backdate_confirm$"),
            CallbackQueryHandler(cancel_backdate, pattern="^backdate_cancel$")
        ]
    },
    fallbacks=[CommandHandler("cancel", cancel_backdate)]
)
```

### 3.2 Modify Existing Habit Done Handler (Quick "Yesterday" Button)

**File**: `src/bot/handlers/habit_done_handler.py`

**Modify `habit_selected_callback()`** (~line 118-194):

After habit selection, instead of immediately completing, show options:
```
‚úÖ Log for Today
üìÖ Log for Yesterday  
üìÜ Select Different Date
```

**Implementation**: Add new callback patterns and state handling for the quick actions.

### 3.3 New Keyboards

**File**: `src/bot/keyboards.py`

**Add `build_completion_date_options_keyboard()`**:
```python
def build_completion_date_options_keyboard(
    habit_id: int | str,
    language: str = 'en'
) -> InlineKeyboardMarkup:
    """Build keyboard with Today/Yesterday/Select Date options."""
```

Buttons:
- "‚úÖ Today" ‚Üí `habit_{habit_id}_today`
- "üìÖ Yesterday" ‚Üí `habit_{habit_id}_yesterday`
- "üìÜ Select Date" ‚Üí `backdate_habit_{habit_id}`
- "¬´ Back" ‚Üí `menu_back`

**Add `build_date_picker_keyboard()`**:
```python
def build_date_picker_keyboard(
    habit_id: int | str,
    completed_dates: list[date],
    language: str = 'en'
) -> InlineKeyboardMarkup:
    """Build 7-day date picker showing which dates are already completed."""
```

Layout (example for today = Nov 30):
```
Nov 23 ‚úì | Nov 24   | Nov 25   | Nov 26 ‚úì
Nov 27   | Nov 28   | Nov 29   | Nov 30 (today)
        ¬´ Back
```
- Dates with checkmarks (‚úì) are already completed (disabled/show different callback)
- Clicking an available date opens confirmation

**Add `build_backdate_confirmation_keyboard()`**:
```python
def build_backdate_confirmation_keyboard(
    habit_id: int | str,
    target_date: date,
    language: str = 'en'
) -> InlineKeyboardMarkup:
    """Build confirmation keyboard for backdated completion."""
```

Buttons:
- "‚úÖ Confirm" ‚Üí `backdate_confirm`
- "‚ùå Cancel" ‚Üí `backdate_cancel`

## Phase 4: Messages

**File**: `src/bot/messages.py`

**Add new message constants**:

```python
# Backdate Messages
HELP_BACKDATE_SELECT_HABIT = "üìÖ Which habit would you like to log for a past date?"
HELP_BACKDATE_SELECT_DATE = "üìÜ Select the date you completed <b>{habit_name}</b>:\n\n‚úì = already logged"
HELP_BACKDATE_CONFIRM = "Log <b>{habit_name}</b> for <b>{date}</b>?"
SUCCESS_BACKDATE_COMPLETED = "‚úÖ <b>Habit backdated:</b> {habit_name}\nüìÖ <b>Date:</b> {date}"
ERROR_BACKDATE_DUPLICATE = "‚ùå You already logged <b>{habit_name}</b> on {date}."
ERROR_BACKDATE_TOO_OLD = "‚ùå Cannot backdate more than 7 days."
ERROR_BACKDATE_FUTURE = "‚ùå Cannot log habits for future dates."
ERROR_BACKDATE_BEFORE_CREATED = "‚ùå Cannot backdate before habit was created ({date})."
BUTTON_TODAY = "‚úÖ Today"
BUTTON_YESTERDAY = "üìÖ Yesterday"
BUTTON_SELECT_DATE = "üìÜ Select Date"
```

**Add translations** for `ru` and `kk` languages in `_TRANSLATIONS` dict.

## Phase 5: Main Bot Registration

**File**: `src/bot/main.py`

**Register new handler** (~after line 52):
```python
from src.bot.handlers.backdate_handler import backdate_conversation
# ...
application.add_handler(backdate_conversation)
```

**Update help message** to mention `/backdate` command.

## Phase 6: Unit Tests

**File**: `tests/test_backdate_habit.py` (NEW)

### Test Categories:

#### 6.1 Service Layer Tests

```python
class TestBackdateHabitCompletion:
    """Test habit completion with backdating."""

    def test_backdate_yesterday_success(self, habit_service):
        """Backdating to yesterday creates log with correct date."""

    def test_backdate_7_days_ago_success(self, habit_service):
        """Backdating to 7 days ago (limit) works."""

    def test_backdate_8_days_ago_fails(self, habit_service):
        """Backdating beyond 7 days raises ValueError."""

    def test_backdate_future_date_fails(self, habit_service):
        """Future dates raise ValueError."""

    def test_backdate_duplicate_fails(self, habit_service):
        """Duplicate completion on same date raises ValueError."""

    def test_backdate_before_habit_created_fails(self, habit_service):
        """Backdating before habit creation date raises ValueError."""

    def test_backdate_streak_calculation(self, habit_service):
        """Backdated completion correctly updates streak count."""
        # Scenario: Complete for today (streak=1), then backdate yesterday
        # Expected: Today's streak should become 2

    def test_backdate_fills_gap_maintains_streak(self, habit_service):
        """Filling a gap with backdate preserves/updates streak."""
        # Scenario: Complete 3 days ago and today (gap)
        # Backdate yesterday
        # Expected: Streak recalculated correctly

    def test_backdate_reward_selection_works(self, habit_service):
        """Backdated completion still runs reward selection."""
```

#### 6.2 Repository Layer Tests

```python
class TestHabitLogRepository:

    def test_get_log_for_habit_on_date_exists(self):
        """Returns log when completion exists for date."""

    def test_get_log_for_habit_on_date_not_exists(self):
        """Returns None when no completion for date."""
```

#### 6.3 Streak Service Tests

```python
class TestStreakServiceBackdate:

    def test_calculate_streak_for_date_no_prior(self):
        """First backdate completion returns streak=1."""

    def test_calculate_streak_for_date_consecutive(self):
        """Backdate after existing completion increments streak."""

    def test_calculate_streak_for_date_with_gap(self):
        """Backdate with gap resets streak (no grace days)."""

    def test_calculate_streak_for_date_with_grace_days(self):
        """Backdate within grace period maintains streak."""

    def test_calculate_streak_for_date_exempt_weekdays(self):
        """Backdate respects exempt weekday settings."""
```

## Phase 7: Manual Test Scripts

**File**: `docs/features/0020_MANUAL_TESTS.md` (NEW)

### Test Scenarios:

#### Scenario 1: Quick "Log for Yesterday" Button
1. Send `/habit_done`
2. Select a habit from the list
3. Verify "Today", "Yesterday", "Select Date" buttons appear
4. Click "Yesterday"
5. Verify success message shows yesterday's date
6. Run `/habit_done` again
7. Verify the habit is NOT in "pending" list (already done today... but wait, it was yesterday)
8. Verify habit IS in pending list (since we logged yesterday, not today)

#### Scenario 2: Date Picker - 7 Days Back
1. Send `/habit_done`
2. Select a habit
3. Click "Select Date"
4. Verify 7-day calendar appears (today - 6 days back)
5. Click a date with no checkmark
6. Verify confirmation prompt shows correct date
7. Confirm
8. Verify success message with correct date

#### Scenario 3: Duplicate Prevention
1. Complete a habit for today
2. Send `/habit_done`
3. Select same habit
4. Click "Today"
5. Verify error message about duplicate

#### Scenario 4: Calendar Shows Completed Dates
1. Complete a habit for multiple dates (today, 2 days ago)
2. Send `/habit_done` ‚Üí select habit ‚Üí "Select Date"
3. Verify calendar shows ‚úì on completed dates
4. Verify clicking completed date shows error or is disabled

#### Scenario 5: Streak Recalculation
1. Complete habit today (streak=1)
2. Backdate same habit to yesterday
3. Run `/streaks`
4. Verify streak shows 2 days (not 1)

#### Scenario 6: Error Handling - Too Old
1. Create a test habit created 3 days ago
2. Try to backdate to 8 days ago
3. Verify "Cannot backdate more than 7 days" error

#### Scenario 7: Error Handling - Before Creation
1. Create a new habit today
2. Try to backdate to yesterday
3. Verify "Cannot backdate before habit was created" error

## Files Summary

### New Files
- `src/bot/handlers/backdate_handler.py` - Main backdate conversation handler
- `tests/test_backdate_habit.py` - Unit tests for backdate functionality
- `docs/features/0020_MANUAL_TESTS.md` - Manual test scenarios

### Modified Files
- `src/core/repositories.py` - Add `get_log_for_habit_on_date()` method
- `src/services/habit_service.py` - Add `target_date` parameter to `process_habit_completion()`
- `src/services/streak_service.py` - Add `calculate_streak_for_date()` method
- `src/bot/handlers/habit_done_handler.py` - Add quick "Yesterday" button flow
- `src/bot/keyboards.py` - Add date picker and confirmation keyboards
- `src/bot/messages.py` - Add backdate-related messages and translations
- `src/bot/main.py` - Register backdate conversation handler



















