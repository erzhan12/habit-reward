# Feature 0033: User Timezone Support

## Description

`date.today()` uses the system clock (UTC on server). Users in different timezones see wrong dates — e.g., a user in UTC+5 at 02:05 AM local time sees Feb 5 as "yesterday" instead of Feb 6, because `date.today()` returns Feb 6 (UTC) not Feb 7 (local).

This affects all date-dependent logic: "today" completions, "yesterday" completions, streak calculations, date pickers, and duplicate detection.

## Approach

### 1. Add `timezone` field to User model

**File**: `src/core/models.py` — add after `language` field:

```
timezone = CharField(max_length=50, default='UTC')
```

Stores IANA timezone names (e.g., `Asia/Almaty`, `Europe/Moscow`).

**Migration**: `src/core/migrations/0016_add_timezone_to_user.py`

### 2. Create `get_user_today()` helper

**File**: `src/bot/timezone_utils.py` (new)

```python
from datetime import date, datetime
from zoneinfo import ZoneInfo

def get_user_today(user_timezone: str = 'UTC') -> date:
    """Return today's date in the user's timezone."""
    return datetime.now(ZoneInfo(user_timezone)).date()
```

Single function that replaces all `date.today()` calls. We only need the correct **date** from the user's perspective.

### 3. Replace all `date.today()` calls (18 occurrences)

| File | Lines | Usage |
|------|-------|-------|
| `src/bot/handlers/habit_done_handler.py` | 364, 438 | Yesterday calc, date picker |
| `src/bot/handlers/menu_handler.py` | 535, 653, 691, 751 | Today completions, yesterday, date picker |
| `src/bot/handlers/backdate_handler.py` | 150 | Date picker "today" |
| `src/bot/keyboards.py` | 1183 | Date picker keyboard |
| `src/services/habit_service.py` | 177, 180, 277, 370, 763, 769 | Default target_date, validation, timestamps, log creation |
| `src/services/streak_service.py` | 45 | Streak "today" reference |
| `src/core/repositories.py` | 604 | Default date for log queries |
| `src/api/v1/routers/habit_logs.py` | 99 | API default end_date |

**Strategy**:
- **Handlers**: Already have user object or `telegram_id`. Fetch `user.timezone`, call `get_user_today(user.timezone)`, pass result downstream.
- **Services** (`habit_service`, `streak_service`): Add `user_timezone` parameter to `process_habit_completion()` and `calculate_streak()`. Use `get_user_today(user_timezone)` when `target_date` is None.
- **Repositories**: Receive explicit dates from service layer instead of defaulting.
- **Keyboards**: Add `user_timezone` parameter to `build_date_picker_keyboard()`.

### 4. Add timezone setting to bot

Follow the language selection pattern exactly.

**`src/bot/keyboards.py`**:
- Add "Timezone" button to `build_settings_keyboard()` (callback: `settings_timezone`)
- Add `build_timezone_selection_keyboard()` — common timezones (Almaty UTC+5, Moscow UTC+3, etc.) + "Type custom" option

**`src/bot/handlers/settings_handler.py`**:
- `select_timezone_callback()` — show timezone keyboard
- `change_timezone_callback()` — save via `user_repository.update(user.id, {"timezone": tz})`
- New state: `AWAITING_TIMEZONE_SELECTION`

**`src/bot/messages.py`**:
- Add `SETTINGS_TIMEZONE`, `TIMEZONE_SELECTION_MENU`, `TIMEZONE_UPDATED` in EN/RU/KZ

### 5. Auto-detection

Telegram API does NOT provide user timezone. Default new users to `UTC`. Users set their timezone via Settings.

## Files to modify

| File | Change |
|------|--------|
| `src/core/models.py` | Add `timezone` field |
| `src/core/migrations/0016_*.py` | New migration |
| `src/bot/timezone_utils.py` | **New** — `get_user_today()` |
| `src/services/habit_service.py` | Replace 6x `date.today()` |
| `src/services/streak_service.py` | Replace 1x `date.today()` |
| `src/core/repositories.py` | Replace 1x `date.today()` |
| `src/bot/handlers/habit_done_handler.py` | Replace 2x `date.today()` |
| `src/bot/handlers/menu_handler.py` | Replace 4x `date.today()` |
| `src/bot/handlers/backdate_handler.py` | Replace 1x `date.today()` |
| `src/bot/keyboards.py` | Replace 1x `date.today()`, add timezone keyboard |
| `src/bot/handlers/settings_handler.py` | Add timezone setting handlers |
| `src/bot/messages.py` | Add timezone messages (3 languages) |
| `src/api/v1/routers/habit_logs.py` | Replace 1x `date.today()` |
| `src/core/admin.py` | Add `timezone` to User admin display |

## Unit Tests

**`tests/bot/test_timezone_utils.py`**:
- `get_user_today()` returns correct date for UTC+5 when UTC date differs
- `get_user_today()` returns correct date for UTC-8
- `get_user_today('UTC')` matches UTC `date.today()`
- Invalid timezone falls back to UTC

**`tests/services/test_habit_service_timezone.py`**:
- `process_habit_completion` with `target_date=None` and user in UTC+5 uses correct local date
- Yesterday calculation uses user's timezone
