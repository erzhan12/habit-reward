# Feature 0023: Hide Piece Price Field in Telegram Reward Commands

## Overview

Simplify the Telegram reward management UX by removing the "pieces price" / `piece_value` step from the `/add_reward` and `/edit_reward` bot commands. Rewards created or edited via Telegram should no longer prompt for or display a piece price; instead, they rely on backend defaults (typically `None`). The underlying data model and API keep supporting `piece_value` so it can be reintroduced in the future or managed via admin/API.

User intent from the prompt:
- "commands/plan_feature.md from ADD_REWARD ,EDIT_REWARD commands remove pieces price field."
- "I don't want to maintain that field. Let it be default value , maybe in the future I will return this field."

## Current Behavior (High-Level)

1. `/add_reward` flow (`src/bot/handlers/reward_handlers.py`):
   - Asks for reward name, type, weight, and `pieces_required`.
   - After `pieces_required`, it prompts for piece price via `HELP_ADD_REWARD_PIECE_VALUE_PROMPT`, using:
     - Conversation state `AWAITING_REWARD_VALUE`.
     - Handlers `reward_piece_value_received` and `reward_piece_value_skip`.
     - Keyboard `build_reward_piece_value_keyboard` (from `src/bot/keyboards.py`).
   - Summary builder `_format_reward_summary` injects a formatted `piece_value` into `HELP_ADD_REWARD_CONFIRM`.
   - On confirmation, `reward_confirm_save` pulls `piece_value` from `reward_data` and passes it to `reward_service.create_reward`.

2. `/edit_reward` flow (`src/bot/handlers/reward_handlers.py`):
   - After selecting a reward, the bot walks through name, type, weight, and `pieces_required`.
   - Then it prompts to edit piece price using `HELP_EDIT_REWARD_PIECE_VALUE_PROMPT` and `build_reward_edit_piece_value_keyboard`.
   - Conversation state `AWAITING_REWARD_EDIT_VALUE` uses handlers:
     - `reward_edit_piece_value_skip`
     - `reward_edit_piece_value_clear`
     - `reward_edit_piece_value_received`
   - Confirmation builder `_reward_edit_build_confirm` shows both old and new piece values in `HELP_EDIT_REWARD_CONFIRM`.
   - `reward_edit_confirmed` writes `piece_value` back via a field in the `updates` dict sent to `reward_repository.update`.

3. Backend and API:
   - Data model: `Reward.piece_value` exists in `src/core/models.py` and underlying migrations.
   - Service layer: `RewardService.create_reward` accepts an optional `piece_value` and only adds it to the payload when not `None`.
   - API layer: `src/api/v1/routers/rewards.py` exposes `piece_value` in create/update/read DTOs and allows clearing it by setting `null`.
   - Tests: service and API tests under `tests/` rely on `piece_value` being persisted and returned correctly, but there are no tests that depend on Telegram prompts for piece price.

## Goals and Non-Goals

Goals:
- Remove the "piece price" / `piece_value` prompt and editing step from `/add_reward` and `/edit_reward` Telegram flows.
- Ensure Telelgram users can still create and edit rewards without errors or confusing references to a price field.
- Keep `piece_value` fully supported in the data model, services, and API so it can be used by other clients or re-enabled later.

Non-goals:
- No database or schema changes to the `Reward` model.
- No behavior changes to API endpoints or dashboard logic that already use `piece_value`.
- No removal of `piece_value` from non-Telegram documentation or REST contracts.

## Files and Components to Touch

Primary Telegram bot changes:
- `src/bot/handlers/reward_handlers.py`
  - Add reward flow: `reward_pieces_selected`, `reward_pieces_received`, `_format_reward_summary`, `reward_confirm_save`, and piece-value-specific handlers.
  - Edit reward flow: `reward_edit_selected`, piece-value edit handlers, `_reward_edit_build_confirm`, `_reward_edit_show_confirm`, `reward_edit_confirmed`.
  - Conversation handler definition `add_reward_conversation` and reward edit states.
- `src/bot/keyboards.py`
  - `build_reward_piece_value_keyboard`
  - `build_reward_edit_piece_value_keyboard`
- `src/bot/messages.py`
  - Message keys and text containing piece price prompts and confirmations:
    - `HELP_ADD_REWARD_PIECE_VALUE_PROMPT`
    - `ERROR_REWARD_PIECE_VALUE_INVALID`
    - `HELP_ADD_REWARD_CONFIRM` (includes a "Piece Value" line)
    - `HELP_EDIT_REWARD_PIECE_VALUE_PROMPT`
    - `HELP_EDIT_REWARD_CONFIRM` (includes a "Piece Value" line)
  - Localized variants in `ru` and `kk` inside `_TRANSLATIONS`.

Documentation and rules:
- `RULES.md`
  - Unified Reward System and reward UX guidelines, to explicitly state that Telegram commands do not manage `piece_value` and rely on defaults.

Tests:
- `tests/test_bot_handlers.py`
  - Add tests (or adjust existing ones) to cover the updated `/add_reward` and `/edit_reward` flows where piece price is no longer prompted.

## Detailed Implementation Plan

### 1. Remove Piece Price Step from `/add_reward`

1.1 Rewire the conversation flow:
- After successfully capturing `pieces_required` in `reward_pieces_selected` and `reward_pieces_received`, transition directly to the confirmation step (`AWAITING_REWARD_CONFIRM`) instead of `AWAITING_REWARD_VALUE`.
- Update the `add_reward_conversation` state machine to:
  - Remove the `AWAITING_REWARD_VALUE` state.
  - Ensure all transitions now go: name → type → weight → pieces → confirm.

1.2 Adjust reward data handling:
- When building `reward_data` during the flow, stop setting or relying on a transient `piece_value` key for Telegram-created rewards.
- Confirm that `reward_confirm_save` calls `RewardService.create_reward` without forcing a non-default `piece_value`. It should either:
  - Omit `piece_value` entirely from the call, or
  - Explicitly pass `None`, relying on the service to ignore it and use model defaults.

1.3 Update summary formatting:
- Update `_format_reward_summary` so:
  - It no longer formats or injects `piece_value`.
  - It passes only name, type label, weight, and pieces into `HELP_ADD_REWARD_CONFIRM`.
- Simplify the `HELP_ADD_REWARD_CONFIRM` template to remove the "Piece Value" line from all languages.

1.4 Deactivate piece-value-specific handlers and keyboard:
- Remove `reward_piece_value_received` and `reward_piece_value_skip` from the conversation state mapping so they are no longer reachable from Telegram.
- Remove `build_reward_piece_value_keyboard` usage from the add reward flow.
- Decide whether to:
  - Keep these helpers as unused (documented as dormant for potential future reactivation), or
  - Remove them entirely if there is no risk of breaking other flows. The default plan assumes leaving backend helpers available but disconnected from Telegram UX.

### 2. Remove Piece Price Editing from `/edit_reward`

2.1 Stop prompting for piece price:
- In `reward_edit_selected`, stop capturing `old_piece_value` into the edit context if it is only used for Telegram prompts.
- After editing `pieces_required` in the edit flow, navigate directly to the confirmation screen instead of a separate "edit piece value" step.
- Remove transitions into `AWAITING_REWARD_EDIT_VALUE` from the conversation, effectively shortening the edit path to: select reward → (name / type / weight / pieces) → confirm.

2.2 Simplify confirmation message:
- Update `_reward_edit_build_confirm` so the confirm message no longer references `old_value` or `new_value`.
- Simplify `HELP_EDIT_REWARD_CONFIRM` and translations to remove the "Piece Value" line from the summary (in all locales).

2.3 Preserve existing `piece_value` on edit:
- In `reward_edit_confirmed`, ensure that the `updates` dict:
  - Does not introduce an edited `piece_value` when called from Telegram.
  - Leaves `piece_value` unchanged for existing rewards (i.e., do not accidentally clear or overwrite it when editing other fields).
- Concretely, this means dropping `piece_value` from the updates payload built in `reward_edit_confirmed`, so the repository update call does not touch that field.

2.4 Deactivate edit-piece-value handlers and keyboard:
- Remove `reward_edit_piece_value_skip`, `reward_edit_piece_value_clear`, and `reward_edit_piece_value_received` from the reward edit conversation states, as well as callbacks like `edit_reward_value_skip` and `edit_reward_value_clear`.
- Remove the use of `build_reward_edit_piece_value_keyboard` from the edit flow.
- As with the add flow, decide whether the underlying helper and message keys remain defined but unused, or are removed to keep the code surface smaller. The default plan is to disconnect them from Telegram while leaving model and API behavior unchanged.

### 3. Backend Defaults and Consistency

3.1 Confirm service-level defaults:
- Verify that `RewardService.create_reward` and any other reward creation paths:
  - Treat a missing or `None` `piece_value` as "no monetary value", relying on the model’s default (nullable field).
  - Do not raise validation errors when `piece_value` is omitted.

3.2 Ensure edit paths do not regress:
- Confirm that reward update logic in repositories and services does not require `piece_value` in the update payload.
- Ensure that other clients (admin site, REST API, dashboard) that still use `piece_value` continue working as-is; they are outside the Telegram scope of this change.

### 4. Rules and Documentation Alignment

4.1 Update `RULES.md`:
- In the Unified Reward System and reward UX sections, add explicit guidance that:
  - `/add_reward` and `/edit_reward` Telegram commands must not prompt for or modify `piece_value`.
  - Telegram-created rewards rely on the default `piece_value` (typically `None`).
  - `piece_value` remains an optional analytical field for API and dashboard use, and may be reintroduced into Telegram flows later.

4.2 Avoid broader doc churn:
- Do not change API docs, test plans, or dashboard documentation that already describe `piece_value` as a supported field, since only the Telegram UX is being simplified in this feature.

## Testing Plan

### Bot Flow Tests

- `/add_reward` happy path:
  - Given an active user, walk through name, type, weight, and pieces.
  - Verify that after entering `pieces_required`, the next step is the confirmation summary, not a piece price prompt.
  - Assert that the confirmation summary text no longer mentions "Piece Value" in any language.

- `/add_reward` regression checks:
  - Ensure that cancelling during name/type/weight/pieces still works.
  - Ensure that invalid weight and pieces inputs still show the correct validation errors and keyboard options.

- `/edit_reward` happy path:
  - Given an existing reward with or without `piece_value`, walk through editing name, type, weight, and pieces.
  - Verify that there is no step prompting to edit piece price.
  - Confirm that the edit summary no longer mentions piece price.

- `/edit_reward` preservation of `piece_value`:
  - Start with a reward that has a non-null `piece_value`.
  - Edit only name/weight/pieces via Telegram.
  - Confirm via repository mock assertions that `piece_value` is not changed in the update payload.

### Service and API Tests (Regression)

- Service tests:
  - Ensure existing tests around `RewardService.create_reward` still pass when `piece_value` is optional and not always provided.
  - Add a case where create is called without `piece_value` and assert that the resulting reward has `piece_value` unset or `None`.

- API tests:
  - Keep tests that create/update rewards with `piece_value` via REST to confirm behavior is unchanged.
  - Add or retain a test that clears `piece_value` by setting it to `null` via PATCH and confirm it is persisted as `None`.

### Manual Checks

- Run the bot and manually exercise:
  - `/add_reward` and `/edit_reward` flows in all supported languages (en, ru, kk) to verify no references to piece price appear.
  - Existing reward progress flows (`/my_rewards`, `/list_rewards`, `/claim_reward`) to ensure they still behave the same, regardless of `piece_value`.

## Risks and Mitigations

- Risk: Accidentally clearing or overwriting `piece_value` when editing rewards via Telegram.
  - Mitigation: Ensure edit updates omit `piece_value` entirely, and add tests that assert it is preserved.

- Risk: Leaving dead conversation states or unused callbacks that confuse future maintenance.
  - Mitigation: Clearly separate Telegram-facing UX (no piece price) from reusable helpers; document unused pieces in code comments if retained.

- Risk: Inconsistent localization if some languages still reference piece price in messages.
  - Mitigation: Update all translations for the confirmation messages to remove the "Piece Value" line and verify in manual tests per locale.

