# Feature 0011: Add "Add Habit" Option When No Habits Available for Editing

## Description

When a user navigates to **Habits ‚Üí Edit Habit** and has no habits to edit, they currently receive the message "You don't have any habits to edit" and the conversation ends. This feature will enhance the user experience by offering the option to add a new habit directly from this flow, instead of forcing the user to navigate back to the menu and select "Add Habit" separately.

## User Flow

Current behavior:
1. User starts bot ‚Üí Main Menu
2. User clicks "üß© Habits" ‚Üí Habits Menu
3. User clicks "‚úèÔ∏è Edit Habit"
4. Bot shows: "‚ùå You don't have any habits to edit." (conversation ends)

Desired behavior:
1. User starts bot ‚Üí Main Menu
2. User clicks "üß© Habits" ‚Üí Habits Menu
3. User clicks "‚úèÔ∏è Edit Habit"
4. Bot detects no habits exist
5. Bot shows: "‚ùå You don't have any habits to edit. Would you like to add a new habit?"
6. Bot displays inline keyboard with:
   - "‚ûï Add Habit" button
   - "¬´ Back" button (returns to Habits Menu)
7. If user clicks "Add Habit", redirect to add_habit conversation flow

## Files to Modify

### 1. `src/bot/handlers/habit_management_handler.py`

**Function: `edit_habit_callback()` (lines 319-362)**

Current implementation:
- Checks if habits list is empty (line 347)
- Sends error message and returns `ConversationHandler.END` (lines 349-351)

Required changes:
- When no habits found, instead of ending conversation, send message with keyboard offering to add habit
- Add new callback handler to redirect to add habit flow
- **CRITICAL**: Return `AWAITING_HABIT_SELECTION` instead of `ConversationHandler.END` to keep conversation alive so buttons remain functional

**New callback handler needed:**
```python
async def edit_to_add_habit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Redirect from edit habit (no habits) to add habit flow."""
```

This handler should:
- Answer the callback query
- Clear any edit context from `context.user_data`
- Send the first prompt from add habit flow (habit name prompt) using `query.edit_message_text()`
- Return `AWAITING_HABIT_NAME` state to transition into add_habit conversation flow

### 2. `src/bot/keyboards.py`

**New keyboard builder needed:**
```python
def build_no_habits_to_edit_keyboard(language: str = 'en') -> InlineKeyboardMarkup:
    """
    Build keyboard for when no habits exist to edit.

    Buttons:
    - ‚ûï Add Habit
    - ¬´ Back (to Habits Menu)
    """
```

Layout:
- Row 1: [‚ûï Add Habit] with callback_data="edit_add_habit"
- Row 2: [¬´ Back] with callback_data="edit_back"

### 3. `src/bot/messages.py`

**New message constant:**

Add to `Messages` class and all translations (en, ru, kk):

```python
ERROR_NO_HABITS_TO_EDIT_PROMPT = "‚ùå You don't have any habits to edit.\n\nWould you like to add a new habit?"
```

Translations:
- **Russian (ru)**: "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.\n\n–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É?"
- **Kazakh (kk)**: "‚ùå ”®“£–¥–µ—É–≥–µ ”ô–¥–µ—Ç—Ç–µ—Ä—ñ“£—ñ–∑ –∂–æ“õ.\n\n–ñ–∞“£–∞ ”ô–¥–µ—Ç “õ–æ—Å“õ—ã“£—ã–∑ –∫–µ–ª–µ –º–µ?"

**Note:** Keep existing `ERROR_NO_HABITS_TO_EDIT` message for command-based flow (`/edit_habit` command).

### 4. Conversation Handler Integration

The edit_habit_conversation handler needs to support transitioning to add_habit flow.

**Implementation approach:**

Add the `edit_to_add_habit` callback as an entry point to the `add_habit_conversation` handler:
- When user clicks "Add Habit" button, it triggers `edit_to_add_habit` callback
- This callback displays the habit name prompt and returns `AWAITING_HABIT_NAME` state
- The `add_habit_conversation` handler picks up from this state and continues the flow
- This approach keeps conversations logically separate while allowing seamless transition

## Implementation Steps

### Step 1: Add message constant
- Add `ERROR_NO_HABITS_TO_EDIT_PROMPT` to `Messages` class
- Add translations for Russian and Kazakh
- Keep existing `ERROR_NO_HABITS_TO_EDIT` unchanged (used by command flow)

### Step 2: Create keyboard builder
- Add `build_no_habits_to_edit_keyboard()` to `src/bot/keyboards.py`
- Use callback patterns: `edit_add_habit` and `edit_back`

### Step 3: Modify `edit_habit_callback()`
In `src/bot/handlers/habit_management_handler.py`:
- Update no-habits branch (lines 348-357)
- Replace simple error message with new message + keyboard
- Use `ERROR_NO_HABITS_TO_EDIT_PROMPT` instead of `ERROR_NO_HABITS_TO_EDIT`
- Attach `build_no_habits_to_edit_keyboard(lang)` keyboard
- **CRITICAL**: Return `AWAITING_HABIT_SELECTION` instead of `ConversationHandler.END`
  - This keeps the conversation alive so the Back button handler remains active
  - The `edit_back` callback is registered in `AWAITING_HABIT_SELECTION` state (line 934)

### Step 4: Add redirect callback handler
Create new function `edit_to_add_habit()` in same file (lines 613-632):
- Answer callback query
- Clear `context.user_data` to remove any edit flow data
- Display habit name prompt: `msg('HELP_ADD_HABIT_NAME_PROMPT', lang)`
- Return `AWAITING_HABIT_NAME` to transition into add_habit flow

### Step 5: Update add_habit_conversation handler
In `add_habit_conversation` definition (lines 902-923):
- Add `CallbackQueryHandler(edit_to_add_habit, pattern="^edit_add_habit$")` to entry_points
- This allows the "Add Habit" button callback to start the add_habit conversation flow
- The conversation will continue from `AWAITING_HABIT_NAME` state through the normal add habit flow

### Step 6: Handle the "Back" button
The existing `edit_back_to_menu` callback (already registered in `AWAITING_HABIT_SELECTION` state at line 934) will handle returning to Habits Menu. No changes needed.

## Edge Cases

1. **User clicks "Add Habit" but is no longer active**
   - Solution: add_habit_command already validates user status (lines 69-74)

2. **User is in edit flow, clicks "Add Habit", then cancels add flow**
   - Solution: Both flows use independent ConversationHandlers with fallbacks
   - Cancel in add_habit returns END, user can start new command

3. **Multiple navigation paths to add habit**
   - Menu ‚Üí Habits ‚Üí Add Habit (existing)
   - Menu ‚Üí Habits ‚Üí Edit Habit ‚Üí Add Habit (new)
   - Both use same entry point: `add_habit_command()`

## Testing Checklist

1. **No habits exist**
   - Navigate to Edit Habit
   - Verify message shows prompt with "Add Habit" button
   - Click "Add Habit" ‚Üí should start add habit flow
   - Complete add habit flow ‚Üí habit should be created

2. **Back button from no-habits screen**
   - Navigate to Edit Habit (no habits)
   - Click "¬´ Back" ‚Üí should return to Habits Menu

3. **Habits exist**
   - Add at least one habit
   - Navigate to Edit Habit
   - Verify normal habit selection keyboard appears (no change to existing behavior)

4. **Multi-language support**
   - Test with Russian language user
   - Test with Kazakh language user
   - Verify all messages and buttons display correctly

5. **Cancel during add habit**
   - Navigate to Edit Habit ‚Üí Add Habit
   - Send `/cancel` during add habit flow
   - Verify conversation ends gracefully

## Implementation Notes

- This feature enhances UX by reducing navigation steps
- Maintains existing functionality (command-based `/edit_habit` unchanged)
- Follows established patterns: message constants, keyboard builders, conversation handlers
- No database schema changes required
- No changes to service layer or repositories
- Pure UI/UX enhancement at handler level

## Implementation Details (Completed)

### Files Modified

1. **`src/bot/messages.py`** (lines 138, 278, 416)
   - Added `ERROR_NO_HABITS_TO_EDIT_PROMPT` constant with translations in English, Russian, and Kazakh

2. **`src/bot/keyboards.py`** (lines 375-397)
   - Added `build_no_habits_to_edit_keyboard()` function
   - Returns keyboard with "‚ûï Add Habit" (callback: `edit_add_habit`) and "¬´ Back" (callback: `edit_back`) buttons

3. **`src/bot/handlers/habit_management_handler.py`**
   - Line 23: Added import for `build_no_habits_to_edit_keyboard`
   - Lines 348-357: Modified `edit_habit_callback()` to show prompt with keyboard when no habits
   - **Line 357**: Returns `AWAITING_HABIT_SELECTION` (not `ConversationHandler.END`) to keep conversation alive
   - Lines 613-632: Added `edit_to_add_habit()` redirect callback handler
   - Line 906: Added `CallbackQueryHandler(edit_to_add_habit, pattern="^edit_add_habit$")` to `add_habit_conversation` entry_points

### Key Fix Applied

**Problem discovered during testing:** The Back button wasn't working because the conversation ended immediately (returned `ConversationHandler.END`) when no habits were found.

**Solution:** Changed the return value in `edit_habit_callback()` from `ConversationHandler.END` to `AWAITING_HABIT_SELECTION`. This keeps the conversation alive, allowing the `edit_back_to_menu` callback (already registered for the `edit_back` pattern in that state) to function correctly.

### Conversation Flow

1. **No habits scenario:**
   - User clicks "Edit Habit" ‚Üí `edit_habit_callback()` runs
   - No habits found ‚Üí Shows prompt with buttons
   - Conversation enters `AWAITING_HABIT_SELECTION` state
   - **Back button**: Handled by existing `edit_back_to_menu` ‚Üí Returns to Habits Menu
   - **Add Habit button**: Triggers `edit_to_add_habit` ‚Üí Starts `add_habit_conversation` at `AWAITING_HABIT_NAME` state

2. **Habits exist scenario:**
   - User clicks "Edit Habit" ‚Üí `edit_habit_callback()` runs
   - Habits found ‚Üí Shows normal habit selection keyboard
   - Conversation enters `AWAITING_HABIT_SELECTION` state (unchanged behavior)
